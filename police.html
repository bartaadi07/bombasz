<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>Police training</title>
<style>
  body { margin: 0; overflow: hidden; background: #87ceeb; font-family: 'Segoe UI', sans-serif; }
  #ui { position: absolute; top: 20px; left: 20px; z-index: 10; pointer-events: none; color: white; text-shadow: 2px 2px #000; }
  #hp-bar-outer { width: 250px; height: 20px; background: rgba(0,0,0,0.5); border: 2px solid #000; }
  #hp-bar-inner { width: 100%; height: 100%; background: #00ff44; transition: width 0.1s; }
  #game-over {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); color: white;
    display: none; flex-direction: column; align-items: center; justify-content: center;
    z-index: 100; text-align: center;
  }
  #retry-btn { padding: 15px 30px; font-size: 20px; cursor: pointer; background: #00ff44; border: none; font-weight: bold; border-radius: 5px; margin-top: 20px; }
  #crosshair { position: absolute; top: 50%; left: 50%; width: 24px; height: 24px; transform: translate(-50%, -50%); pointer-events: none; }
  #crosshair::before { content: ''; position: absolute; top: 11px; left: 0; width: 24px; height: 2px; background: #ff0000; }
  #crosshair::after { content: ''; position: absolute; top: 0; left: 11px; width: 2px; height: 24px; background: #ff0000; }
</style>
</head>
<body>

<div id="ui">
  <div style="font-size: 28px; font-weight: bold;">ELKAPOTT BŰNÖZŐK: <span id="score">0</span></div>
  <div id="hp-bar-outer"><div id="hp-bar-inner"></div></div>
</div>

<div id="crosshair"></div>

<div id="game-over">
  <h1>VÉGE A SZOLGÁLATNAK, SZÉT LETTÉL SZÚRVA</h1>
  <h1 id="final-score">Elkapott bűnözők: 0</h1>
  <button id="retry-btn" onclick="location.reload()">ÚJRATÖLTÉS</button>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.module.js",
    "three/addons/controls/": "https://cdn.jsdelivr.net/npm/three@0.160.1/examples/jsm/controls/"
  }
}
</script>

<script type="module">
import * as THREE from "three";
import { PointerLockControls } from "three/addons/controls/PointerLockControls.js";

let score = 0, hp = 100, isDead = false;
const enemies = [], bullets = [];
let moveFwd = false, moveBkd = false, moveLft = false, moveRgt = false, canJump = false;
let velocity = new THREE.Vector3();
const PLAYER_HEIGHT = 2.0;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff, 0.8));
const sun = new THREE.DirectionalLight(0xffffff, 0.6);
sun.position.set(50, 100, 50);
scene.add(sun);

const ground = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), new THREE.MeshStandardMaterial({ color: 0x444444 }));
ground.rotation.x = -Math.PI/2;
scene.add(ground);
scene.add(new THREE.GridHelper(1000, 100, 0x000000, 0x222222));

const gunGroup = new THREE.Group();
const gunBarrel = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.16, 0.6), new THREE.MeshStandardMaterial({ color: 0x222222 }));
const gunHandle = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.2, 0.12), new THREE.MeshStandardMaterial({ color: 0x111111 }));
gunHandle.position.set(0, -0.1, 0.2);
gunGroup.add(gunBarrel, gunHandle);
gunGroup.position.set(0.4, -0.4, -0.5); 
camera.add(gunGroup);
scene.add(camera);

const controls = new PointerLockControls(camera, document.body);
document.body.addEventListener('click', () => { if(!isDead) controls.lock(); });

document.addEventListener('keydown', (e) => {
  if(e.code==='KeyW') moveFwd=true; if(e.code==='KeyS') moveBkd=true;
  if(e.code==='KeyA') moveLft=true; if(e.code==='KeyD') moveRgt=true;
  if(e.code==='Space' && canJump) { velocity.y = 12; canJump = false; }
});
document.addEventListener('keyup', (e) => {
  if(e.code==='KeyW') moveFwd=false; if(e.code==='KeyS') moveBkd=false;
  if(e.code==='KeyA') moveLft=false; if(e.code==='KeyD') moveRgt=false;
});

window.addEventListener('mousedown', () => {
  if (!controls.isLocked || isDead) return;
  const b = new THREE.Mesh(new THREE.SphereGeometry(0.15), new THREE.MeshBasicMaterial({ color: 0xffdd00 }));
  b.position.copy(camera.position);
  const dir = new THREE.Vector3();
  camera.getWorldDirection(dir);
  b.velocity = dir.clone().multiplyScalar(3.5); // Finomabb sebesség a jobb találatért
  bullets.push(b);
  scene.add(b);
  gunGroup.position.z += 0.1;
  setTimeout(() => gunGroup.position.z -= 0.1, 50);
});

function spawnEnemy() {
  if (enemies.length >= 25 || isDead) return;
  const e = new THREE.Mesh(new THREE.CapsuleGeometry(0.6, 1.2, 4, 8), new THREE.MeshStandardMaterial({ color: 0x5D4037 }));
  const angle = Math.random() * Math.PI * 2;
  const dist = 50 + Math.random() * 20;
  e.position.set(Math.cos(angle)*dist, 1.2, Math.sin(angle)*dist);
  enemies.push(e);
  scene.add(e);
}
setInterval(spawnEnemy, 600);

let prevTime = performance.now();
function animate() {
  requestAnimationFrame(animate);
  if (isDead) return;
  const time = performance.now();
  const delta = (time - prevTime) / 1000;

  if (controls.isLocked) {
    velocity.y -= 30 * delta; 
    const moveDir = new THREE.Vector3();
    if (moveFwd) moveDir.z += 1; if (moveBkd) moveDir.z -= 1;
    if (moveLft) moveDir.x -= 1; if (moveRgt) moveDir.x += 1;
    moveDir.normalize();

    controls.moveRight(moveDir.x * 20 * delta);
    controls.moveForward(moveDir.z * 20 * delta);
    camera.position.y += velocity.y * delta;

    if (camera.position.y < PLAYER_HEIGHT) { velocity.y = 0; camera.position.y = PLAYER_HEIGHT; canJump = true; }

    enemies.forEach((e) => {
      const distDir = new THREE.Vector3().subVectors(camera.position, e.position);
      distDir.y = 0;
      if (distDir.length() < 1.6) {
        hp -= 0.8;
        document.getElementById('hp-bar-inner').style.width = Math.max(0, hp) + "%";
      }
      e.position.addScaledVector(distDir.normalize(), 0.14);
    });

    for (let i = bullets.length - 1; i >= 0; i--) {
      const b = bullets[i];
      b.position.add(b.velocity);
      
      for (let j = enemies.length - 1; j >= 0; j--) {
        // MEGNÖVELT TALÁLATI TÁVOLSÁG (2.2)
        if (b.position.distanceTo(enemies[j].position) < 2.2) {
          scene.remove(enemies[j]);
          enemies.splice(j, 1);
          score++;
          document.getElementById('score').innerText = score;
          scene.remove(b);
          bullets.splice(i, 1);
          break;
        }
      }
      if (b && b.position.length() > 500) { scene.remove(b); bullets.splice(i, 1); }
    }
  }

  if (hp <= 0 && !isDead) {
    isDead = true;
    controls.unlock();
    document.getElementById('game-over').style.display = 'flex';
    document.getElementById('final-score').innerText = "Elkapott bűnözők: " + score;
  }
  renderer.render(scene, camera);
  prevTime = time;
}
animate();
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>