<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bombasz Vids</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/favicon.ico?v=1.1">
    <style>
        body * {
    cursor: default !important;
}
        .progress-container {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: #444;
            width: 0;
            transition: width 0.3s ease-out;
            border-radius: 0;
        }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: #111;
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }

.series-page-bg {
    pointer-events: none; /* Átengedi a kattintást az alatta lévő elemekre */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0; /* Az app mögött (ami 1), de a body felett */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    opacity: 0;
    transition: opacity 0.5s ease;
    filter: blur(10px);
    transform: scale(1.05);
}

.series-page-bg.visible {
    opacity: 0.6 !important; /* Emeltem az átlátszóságon, hogy látszódjon */
}

/* EZRE CSERÉLD LE: */
.series-page-bg.visible {
    opacity: 0.5;
}

        #login-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: #1A1A1A;
            border-radius: 0;
            padding: 40px;
            width: 90%;
            max-width: 380px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.8), inset 0 0 5px rgba(255, 255, 255, 0.05);
        }

        #login-container h2 {
            text-align: center;
            font-weight: 700;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        #login-container input {
            padding: 12px;
            border-radius: 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            margin-top: 6px;
            transition: all 0.3s;
        }

        #login-container input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: #444;
            box-shadow: 0 0 10px rgba(68, 68, 68, 0.3);
            outline: none;
        }

        .btn {
            padding: 12px 20px;
            border-radius: 0;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            letter-spacing: 0.5px;
        }

        .btn.fill {
            background: #252525;
            color: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .btn.fill:hover {
            background: #444;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
        }

#app {
    position: relative;
    z-index: 1;
    display: none;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
    flex-direction: column;
    height: 100vh;
    width: 100vw;
    
    /* Ez a sor a legfontosabb: */
    background: transparent !important; 
    z-index: 1;
}

        header {
            box-shadow: none;

            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 30px;

            position: relative;
        }

        #profile-btn,
        #logout-btn {
            transition: color 0.3s, transform 0.3s;
            background: none;
            border: none;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
        }

        #profile-btn:hover,
        #logout-btn:hover {
            color: #bbb;
            transform: scale(1.1);
        }

        #logout-btn {
            color: #fff;
            border-radius: 0;
            padding: 5px 8px;
        }

        #logout-btn:hover {
            background: #444;
            box-shadow: none;
        }

        #profile-dropdown {
            position: absolute;
            right: 0;
            top: 45px;
            background: #222;
            border-radius: 0;
            padding: 15px;
            min-width: 250px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: none;
        }

        #watched-list {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #444;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .watched-item {
            display: flex;
            flex-direction: column;
            padding: 8px;
            background: #1A1A1A;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
            border: 1px solid #1A1A1A;
            font-size: 0.9rem;
        }

        .watched-item:hover {
            background: #252525;
        }

        .watched-title {
            font-weight: 600;
            margin-bottom: 3px;
            color: #bbb;
        }

        .watched-progress-text {
            font-size: 0.8em;
            color: #777;
        }

        #search-container {
            position: relative;
        }

        #search-input {
            position: absolute;
            right: 0;
            top: -5px;
            width: 0;
            padding: 5px 10px;
            padding-right: 35px;
            border: none;
            border-radius: 0;
            transition: all 0.3s;
            opacity: 0;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        #search-container.active #search-input {
            width: 200px;
            opacity: 1;
        }

        #search-clear-btn {
            position: absolute;
            right: 5px;
            top: 0;
            bottom: 0;
            margin: auto 0;
            background: transparent;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            width: 30px;
            height: 30px;
            display: none;
            transition: all 0.3s;
            opacity: 0;
            pointer-events: none;
            z-index: 10;
            padding: 0;
        }

        #search-container.active #search-clear-btn {
            opacity: 1;
            pointer-events: auto;
        }


        .main-page {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-items: flex-start;
            gap: 20px;
            padding: 40px;
            flex: 1;
            overflow-y: auto;
            width: 100%;
            box-sizing: border-box;
            transition: filter 0.5s ease;
        }

        .series-card {
            width: 180px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            border-radius: 0;
            overflow: hidden;
            background: #1A1A1A;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
            padding-bottom: 5px;
        }

        .series-card:hover {
            transform: none;
            box-shadow: none;
            background: #252525;
        }

        .series-card img {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
            display: block;
            border-radius: 0;
            transition: transform 0.3s ease-out;
        }

        .series-card:hover img {
            transform: none;
        }

        .series-title {
            width: 100%;
            height: 30px;
            overflow: hidden;
            box-sizing: border-box;
            text-align: center;
            margin-top: 5px;
            font-size: 0.9rem;
            position: relative;
            line-height: 1.2;
            padding: 5px 0;
        }

        @keyframes scrollText {
            0% {
                transform: translateX(0%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        .series-title span {
            display: inline-block;
            padding-left: 0;
            white-space: nowrap;
            animation: none;
            transform: translateX(0%);
            box-sizing: content-box;
        }

        .series-title.scrolling-title span {
            padding-left: 100%;
            animation: scrollText 10s linear infinite;
        }

      .series-page {
    display: none;
    flex: 1;
    height: calc(100vh - 60px); /* Kiszámolja a maradék helyet a header alatt */
    flex-direction: row;
    align-items: flex-start; /* Fontos: megakadályozza, hogy a sidebar függőlegesen kinyúljon */
}

/* A javított sidebar stílus */
.sidebar {
    width: 240px;
    height: fit-content; /* Csak a tartalom (részek) végéig ér */
    max-height: calc(100vh - 100px); /* Megakadályozza, hogy túl sok résznél kilógjon a képernyőről */
    background: rgba(0, 0, 0, 0.3) !important; 
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 20px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow-y: auto; /* Ha sok rész van, ezen belül lehet görgetni */
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin: 20px; /* Modern, lebegő hatást ad neki */
    border-radius: 4px;
}

        .sidebar::-webkit-scrollbar {
            display: none;
            width: 0 !important;
        }

        .sidebar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .sidebar h2 {
            margin: 0 0 10px 0;
            text-align: center;
            font-size: 20px;
        }

        .video-card {
            background: #252525;
            border-radius: 0;
            padding: 10px;
            transition: background 0.2s, border-color 0.2s, transform 0.2s;
            border: 1px solid transparent;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            color: #bbb;
        }

        .video-card.active {
            border-color: #444;
            background: #444;
            color: #fff;
            transform: scale(1.02);
            font-weight: 600;
        }

        .video-card.active .fa-check {
            color: #fff;
        }

        .video-card:not(.active):hover {
            background: #383838;
            transform: scale(1.01);
            border-color: #444;
            color: #fff;
        }

        .video-card.watched:not(.active) {
            background: #161616;
            color: #777;
            border-color: #161616;
        }

        .video-card.watched:not(.active):hover {
            background: #222;
        }

        .watched .fa-check {
            color: #4cff7f;
            margin-left: 5px;
        }


.video-content-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 20px;
    box-sizing: border-box;
    order: 1;
    align-items: center;
    max-width: min(1300px, 85vw);
    margin: 0 auto;
    height: 100%;
    /* A háttérszínt töröltük, hogy átlátszódjon a dinamikus kép */
    background: transparent; 
    border-radius: 0;
}

        .video-frame-container {
            width: 100%;
            position: relative;
            height: 0;
            padding-top: 56.25%;
            max-width: 100%;
            flex-shrink: 0;
            overflow: hidden;
        }

        .video-frame-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
            border-radius: 0;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.8);
        }

        .video-frame-container iframe.indavideo-player {
            width: 100%;
            height: 100%;
        }


        #nextEpisodeBtn {
            background: #252525;
            color: #fff;
            border: 2px solid #444;
            padding: 10px 20px;
            border-radius: 0;
            cursor: pointer;
            margin-top: 20px;
            margin-bottom: 20px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        #nextEpisodeBtn:hover {
            background: #444;
            transform: translateY(-2px);
            border-color: #bbb;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
        }

        .back-button {
            background: #444;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 0;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 500;
        }

        .back-button:hover {
            background: #555;
            transform: scale(1.05);
        }

        @media(max-width:768px) {

            body {
                align-items: flex-start;
                padding-top: 5vh;
                min-height: auto;
            }

            #login-container {
                margin: 0 auto;
            }

header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 30px;
    
    /* Sticky pozíció: így görgetésnél is látszik az üveg hatás */
    position: sticky;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;

    /* Áttetsző sötét háttér */
    background: rgba(0, 0, 0, 0.4) !important; 
    
    /* Üveg hatás (homályosítás) */
    backdrop-filter: blur(15px) !important;
    -webkit-backdrop-filter: blur(15px) !important;
    
    /* Elegáns választóvonal */
    border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: none !important;
    
    /* Simább átmenet a színek között */
    transition: background 0.3s ease;
}

/* Mobil optimalizálás a headernek */
@media (max-width: 768px) {
    header {
        padding: 5px 15px;
        height: 50px;
    }
}

            header h1 {
                font-size: 1.3rem;
            }

            #profile-btn {
                font-size: 0.9rem;
            }

            #profile-btn span {
                display: none;
            }

            #profile-dropdown {
                top: 38px;
                padding: 10px;
                right: 15px;
                border-radius: 0;
            }

            #search-container.active #search-input {
                width: 140px;
                padding-right: 35px;
                border-radius: 0;
            }

            .main-page {
                padding: 20px;
                gap: 15px;
                justify-content: center;
                align-items: flex-start;
            }

            .series-card {
                width: 140px;
            }

            .series-title {
                font-size: 0.85rem;
            }

            .series-page {
                flex-direction: column;
                overflow-y: auto;
                height: 100vh;
            }

            .sidebar {
                width: 240px;
                height: auto;
                max-height: 250px;
                padding: 20px;
                order: 1;
               background: rgba(17, 17, 17, 0.8);
            }

            .video-content-wrapper {
                height: 220px;
                flex: none;
                padding: 15px;
                order: 0;
                background: none;
                margin: 0;
                max-width: 100%;
            }

            .video-frame-container {
                padding-top: 0;
                height: 100%;
            }

            .sidebar h2 {
                margin-bottom: 5px;
                font-size: 1.2rem;
            }

            .video-card {
                font-size: 12px;
                padding: 8px;
                border-radius: 0;
            }

            #nextEpisodeBtn {
                margin-top: 15px;
                max-width: 100%;
                border-radius: 0;
            }

        }

        @media(max-width:480px) {
            .series-card {
                width: 120px;
                margin: 0 auto;
            }

            .series-title {
                font-size: 0.8rem;
            }

            #login-container {
                padding: 30px 20px;
            }
        }
    </style>
</head>

<body>
    <div id="dynamicBackground" class="series-page-bg"></div>

    <div id="login-container">
        <center>
            <h2>Belépés</h2>
            <form id="login-form" novalidate>
                <label>E-mail <br>
                    <input type="email" id="loginEmail" required>
                </label><br><br>
                <label>Jelszó <br>
                    <input type="password" id="loginPassword" minlength="6" required>
                </label><br><br>
                <button type="submit" class="btn fill">Belépés</button>
                <p id="login-msg" class="form-msg" role="status" aria-live="polite"></p>
            </form>
        </center>
    </div>

    <div id="app">
        <header>
            <h2 id="home-btn">Bombasz Vids</h2>
            <div style="display:flex; align-items:center; gap:10px; position:relative;" id="profile-area">
                <div id="search-container">
                    <input type="text" id="search-input" placeholder="Keresés...">
                    <button id="search-clear-btn" aria-label="Keresés törlése" style="display:none;">&times;</button>
                </div>
                <button id="search-btn"
                    style="background:none; border:none; cursor:pointer; color:#fff; display:flex; align-items:center; justify-content:center; width:32px; height:32px;">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        width="20" height="20">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-4.35-4.35M17 10a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </button>
                <button id="profile-btn"><i class="fa-solid fa-user"></i> <span id="username-display"></span></button>

                <div id="profile-dropdown">
                    <p><strong>Üdv,</strong> <span id="profile-name"></span></p>

                    <p style="font-weight: 600; margin-top: 15px; border-top: 1px solid #444; padding-top: 10px;">
                        Legutóbb nézettek:</p>
                    <div id="watched-list" style="display: flex; flex-direction: column; gap: 5px;">
                        <p style="font-size: 0.85rem; color: #777;">Betöltés...</p>
                    </div>
                    <br>

                    <button id="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Kilépés</button>
                </div>
            </div>
        </header>

        <div class="main-page" id="mainPage">
            <div class="series-card" data-series="chainsaw-movie">
                <img src="./reze.png" alt="Chainsaw Man: Reze Arc">
                <div class="series-title"><span>Chainsaw Man - The Movie: Reze Arc</span></div>
            </div>
            <div class="series-card" data-series="chainsaw-series">
                <img src="./chainsawman.webp" alt="Chainsaw Man">
                <div class="series-title"><span>Chainsaw Man</span></div>
            </div>
            <div class="series-card" data-series="deathnote">
                <img src="./deathnote.avif" alt="Death Note">
                <div class="series-title"><span>Death Note</span></div>
            </div>
            <div class="series-card" data-series="record-of-ragnarok-s1">
                <img src="./recordofragnaroks1.jpg" alt="Record of Ragnarok: Season 1">
                <div class="series-title"><span>Record of Ragnarok: Season 1</span></div>
            </div>
            <div class="series-card" data-series="record-of-ragnarok-s2">
                <img src="./recordofragnaroks2.jpg" alt="Record of Ragnarok: Season 2">
                <div class="series-title"><span>Record of Ragnarok: Season 2</span></div>
            </div>

            <div class="series-card" data-series="record-of-ragnarok-s3">
                <img src="./recordofragnaroks3.jpg" alt="Record of Ragnarok: Season 3">
                <div class="series-title"><span>Record of Ragnarok: Season 3</span></div>
            </div>

            <div class="series-card" data-series="Evangelion">
                <img src="./evangelion.jpg" alt="Neon Genesis Evangelion">
                <div class="series-title"><span>Neon Genesis Evangelion</span></div>
            </div>

            <div class="series-card" data-series="endofevangelion">
                <img src="./endofevangelion.jpg" alt="Neon Genesis Evangelion">
                <div class="series-title"><span>Neon Genesis Evangelion: The End of Evangelion</span></div>
            </div>
            <div class="series-card" data-series="youarenotalone">
                <img src="youarenptalone.webp" alt="Neon Genesis Evangelion: You Are Not Alone">
                <div class="series-title"><span>Evangelion - 1.0 You Are (Not) Alone</span></div>
            </div>
            <div class="series-card" data-series="youcannotadvance">
                <img src="youcannotadvance.jpg" alt="Evangelion - 2.0 You Can (Not) Advance">
                <div class="series-title"><span>Evangelion - 2.0 You Can (Not) Advance</span></div>
            </div>
            <div class="series-card" data-series="youcannotredo">
                <img src="youcannotredo.jpg" alt="Evangelion 3.0 You Can (Not) Redo">
                <div class="series-title"><span>Evangelion 3.0 You Can (Not) Redo</span></div>
            </div>
            <div class="series-card" data-series="thriceuponatime">
                <img src="thriceuponatime.webp" alt="Evangelion 3.0 You Can (Not) Redo">
                <div class="series-title"><span>Evangelion: 3.0+1.0 Thrice Upon a Time</span></div>
            </div>
            <div class="series-card" data-series="degeneration">
                <img src="degeneration.jpg" alt="Resident Evil: Degeneration">
                <div class="series-title"><span>Resident Evil: Degeneration</span></div>
            </div>
            <div class="series-card" data-series="infinitedarkness">
                <img src="infinitedarkness.jpg" alt="Resident Evil: Infinite Darkness">
                <div class="series-title"><span>Resident Evil: Infinite Darkness</span></div>
            </div>
            <div class="series-card" data-series="damnation">
                <img src="damnation.jpg" alt="Resident Evil: Damnation">
                <div class="series-title"><span>Resident Evil: Damnation</span></div>
            </div>
            <div class="series-card" data-series="vendetta">
                <img src="vendetta.jpg" alt="Resident Evil: Vendetta">
                <div class="series-title"><span>Resident Evil: Vendetta</span></div>
            </div>
            <div class="series-card" data-series="deathisland">
                <img src="deathisland.webp" alt="Resident Evil: Death Island">
                <div class="series-title"><span>Resident Evil: Death Island</span></div>
            </div>
            <div class="series-card" data-series="fallouts1">
                <img src="fallouts1.jpg" alt="Fallout Season 1">
                <div class="series-title"><span>Fallout Season 1</span></div>
            </div>
            <div class="series-card" data-series="fallouts2">
                <img src="fallouts2.jpg" alt="Fallout Season 2">
                <div class="series-title"><span>Fallout Season 2</span></div>
            </div>
        </div>

        <div class="series-page" id="seriesPage">
            <div class="sidebar">
                <button id="back-btn" class="back-button">
                    <i class="fa-solid fa-arrow-left"></i> Vissza
                </button>
                <h2 id="seriesTitle">Sorozat</h2>
                <div id="videoList"></div>
            </div>
            <div class="video-content-wrapper">
                <div class="video-frame-container">
                </div>
                <button id="nextEpisodeBtn" style="display:none;"></button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getDatabase, ref, set, get, child, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";


        const firebaseConfig = {
            apiKey: "AIzaSyAwRrAtHaNRh2DLwVkryA3wSf86h7aQCaI",
            authDomain: "konyv-93c63.firebaseapp.com",
            projectId: "konyv-93c63",
            storageBucket: "konyv-93c63.firebasestorage.app",
            messagingSenderId: "349471560585",
            appId: "1:349471560585:web:55c6e78499ebbca0540758"
        };

        const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);


        const loginForm = document.getElementById("login-form");
        const loginMsg = document.getElementById("login-msg");
        const loginContainer = document.getElementById("login-container");
        const appContainer = document.getElementById("app");
        const logoutBtn = document.getElementById("logout-btn");
        const profileBtn = document.getElementById("profile-btn");
        const profileDropdown = document.getElementById("profile-dropdown");
        const usernameDisplay = document.getElementById("username-display");
        const profileName = document.getElementById("profile-name");
        const profileEmail = document.getElementById("profile-email");
        const homeBtn = document.getElementById('home-btn');
        const watchedList = document.getElementById('watched-list');
        const profileArea = document.getElementById('profile-area');

        const searchBtn = document.getElementById('search-btn');
        const searchContainer = document.getElementById('search-container');
        const searchInput = document.getElementById('search-input');
        const searchClearBtn = document.getElementById('search-clear-btn');
        const mainPage = document.getElementById('mainPage');
        const seriesPage = document.getElementById('seriesPage');
        const videoList = document.getElementById('videoList');
        const seriesTitle = document.getElementById('seriesTitle');
        const backBtn = document.getElementById('back-btn');

        const videoContainer = document.querySelector('.video-frame-container');
        const nextEpisodeBtn = document.getElementById('nextEpisodeBtn');
        const dynamicBackground = document.getElementById('dynamicBackground');

        let allProgressData = {};

        const seriesData = {
            "chainsaw-movie": {
                title: "Chainsaw Man - The Movie: Reze Arc",
                videos: [
                    { title: "1. rész", src: "https://vkvideo.ru/video_ext.php?oid=-234629758&id=456239018&hd=4", type: 'vkvideo' }
                ]
            },
            "chainsaw-series": {
                "title": "Chainsaw Man",
                "videos": [
                    { "title": "01. rész", "src": "https://mega.nz/embed/i34jHaxJ#2rze3ZC4mwLkf233l-cT-gNNElnZAtvoHJOJPfMilUI", "type": "videa" },
                    { "title": "02. rész", "src": "https://mega.nz/embed/nv4gVSgR#Ft3LTdB4j06VkdD4mxHcsfUhWnFtJqCI5Xj0jbHK6Yk", "type": "videa" },
                    { "title": "03. rész", "src": "https://mega.nz/embed/iiIShLKL#nfuCwaaQAIyPJlM-DAjJRAq-lM1JbjEe4L6D1xFAQ94", "type": "videa" },
                    { "title": "04. rész", "src": "https://mega.nz/embed/vyB3RK5Z#yImAcZSdffDJEAFCIaDVjci340cn8bfkfd3orp-gH4Q", "type": "videa" },
                    { "title": "05. rész", "src": "https://mega.nz/embed/7rRXRDZC#m0RE2jUHgznTcGPFrclDNP-xEyBCjHUeUYUu8FWdI0U", "type": "videa" },
                    { "title": "06. rész", "src": "https://mega.nz/embed/LqxzWTbb#eEDmR3m8_zIpeT-BdNfrKbp27yfZN7ZrYP5Ip2CwQjo", "type": "videa" },
                    { "title": "07. rész", "src": "https://mega.nz/embed/jvJiAAZD#ibghVyfWrp9WfpvkfBuC0O_yqgXpmU4IEb3uXgcqpMw", "type": "videa" },
                    { "title": "08. rész", "src": "https://mega.nz/embed/SrA3AaST#VlRTaCkuB3nnP_iRgd08_0T2HEOcWuoGLbblizEaY-Y", "type": "videa" },
                    { "title": "09. rész", "src": "https://mega.nz/embed/b7Yi1SCD#xLRyzn2Wd6QQ-ccEdA9o47GyrtAtMP8-CxJ7k9O1lGM", "type": "videa" },
                    { "title": "10. rész", "src": "https://mega.nz/embed/Hv5xDRZB#amCkiNUifgnaKxywkoCRWPNGV1c6NlpmdFxkQ95N1Ys", "type": "videa" },
                    { "title": "11. rész", "src": "https://mega.nz/embed/L2wREYAS#cULzLMKs-GY_V9btuCPko-L1jBENQNttm34Hsb14U5o", "type": "videa" },
                    { "title": "12. rész", "src": "https://mega.nz/embed/q3pDGRrR#OfHfr_Nxmxbi2Fplt3LnFaLtd_R9RpTQeiZIdTVf5Hg", "type": "videa" }
                ]
            },
            "deathnote": {
                title: "Death Note",
                videos: [
                    { title: "01. rész", src: "//embed.indavideo.hu/player/video/0b203b1c34", type: 'indavideo' },
                    { title: "02. rész", src: "//embed.indavideo.hu/player/video/6933aa54b7", type: 'indavideo' },
                    { title: "03. rész", src: "//embed.indavideo.hu/player/video/e5784af123", type: 'indavideo' },
                    { title: "04. rész", src: "//embed.indavideo.hu/player/video/9a5c7dd313", type: 'indavideo' },
                    { title: "05. rész", src: "//embed.indavideo.hu/player/video/937eff53b8", type: 'indavideo' },
                    { title: "06. rész", src: "//embed.indavideo.hu/player/video/b943513e4f", type: 'indavideo' },
                    { title: "07. rész", src: "//embed.indavideo.hu/player/video/1970930830", type: 'indavideo' },
                    { title: "08. rész", src: "//embed.indavideo.hu/player/video/50222e8add", type: 'indavideo' },
                    { title: "09. rész", src: "//embed.indavideo.hu/player/video/d686d50524", type: 'indavideo' },
                    { title: "10. rész", src: "//embed.indavideo.hu/player/video/4d14107766", type: 'indavideo' },
                    { title: "11. rész", src: "//embed.indavideo.hu/player/video/795f8e280b", type: 'indavideo' },
                    { title: "12. rész", src: "//embed.indavideo.hu/player/video/70f38bd78a", type: 'indavideo' },
                    { title: "13. rész", src: "//embed.indavideo.hu/player/video/e3f848b673", type: 'indavideo' },
                    { title: "14. rész", src: "//embed.indavideo.hu/player/video/ea4479c6e8", type: 'indavideo' },
                    { title: "15. rész", src: "//embed.indavideo.hu/player/video/a7983034e3", type: 'indavideo' },
                    { title: "16. rész", src: "//embed.indavideo.hu/player/video/932d9f3317", type: 'indavideo' },
                    { title: "17. rész", src: "//embed.indavideo.hu/player/video/a4e723f5dc", type: 'indavideo' },
                    { title: "18. rész", src: "//embed.indavideo.hu/player/video/a273ea4497", type: 'indavideo' },
                    { title: "19. rész", src: "//embed.indavideo.hu/player/video/f3ce246582", type: 'indavideo' },
                    { title: "20. rész", src: "//embed.indavideo.hu/player/video/e5da6af423", type: 'indavideo' },
                    { title: "21. rész", src: "//embed.indavideo.hu/player/video/77979c4cac", type: 'indavideo' },
                    { title: "22. rész", src: "//embed.indavideo.hu/player/video/9e2463619c", type: 'indavideo' },
                    { title: "23. rész", src: "//embed.indavideo.hu/player/video/99c0d5fb6b", type: 'indavideo' },
                    { title: "24. rész", src: "//embed.indavideo.hu/player/video/71cd1036af", type: 'indavideo' },
                    { title: "25. rész", src: "//embed.indavideo.hu/player/video/c1e3575648", type: 'indavideo' },
                    { title: "26. rész", src: "//embed.indavideo.hu/player/video/a1c1127501", type: 'indavideo' },


                ]
            },
            "record-of-ragnarok-s1": {
                title: "Record of Ragnarok: Season 1",
                videos: [
                    { title: "01. rész", src: "//embed.indavideo.hu/player/video/47eba82d74", type: 'indavideo' },
                    { title: "02. rész", src: "//embed.indavideo.hu/player/video/64bcd4632e", type: 'indavideo' },
                    { title: "03. rész", src: "//embed.indavideo.hu/player/video/415715ab33", type: 'indavideo' },
                    { title: "04. rész", src: "//embed.indavideo.hu/player/video/db57f4f66f", type: 'indavideo' },
                    { title: "05. rész", src: "//embed.indavideo.hu/player/video/0981a0913f", type: 'indavideo' },
                    { title: "06. rész", src: "//embed.indavideo.hu/player/video/53fe4c1471", type: 'indavideo' },
                    { title: "07. rész", src: "//embed.indavideo.hu/player/video/a2fad56e36", type: 'indavideo' },
                    { title: "08. rész", src: "//embed.indavideo.hu/player/video/2590d2b062", type: 'indavideo' },
                    { title: "09. rész", src: "//embed.indavideo.hu/player/video/8425e0a195", type: 'indavideo' },
                    { title: "10. rész", src: "//embed.indavideo.hu/player/video/556f010595", type: 'indavideo' },
                    { title: "11. rész", src: "//embed.indavideo.hu/player/video/7ee6e9fe63", type: 'indavideo' },
                    { title: "12. rész", src: "//embed.indavideo.hu/player/video/38d878ec19", type: 'indavideo' },
                ]
            },
            "record-of-ragnarok-s2": {
                title: "Record of Ragnarok: Season 2",
                videos: [
                    { title: "01. rész", src: "//embed.indavideo.hu/player/video/b36154b500", type: 'indavideo' },
                    { title: "02. rész", src: "//embed.indavideo.hu/player/video/e2292c54d4", type: 'indavideo' },
                    { title: "03. rész", src: "//embed.indavideo.hu/player/video/072ed4adbf", type: 'indavideo' },
                    { title: "04. rész", src: "//embed.indavideo.hu/player/video/0598413057", type: 'indavideo' },
                    { title: "05. rész", src: "//embed.indavideo.hu/player/video/f305511ae3", type: 'indavideo' },
                    { title: "06. rész", src: "//embed.indavideo.hu/player/video/1cd39537c6", type: 'indavideo' },
                    { title: "07. rész", src: "//embed.indavideo.hu/player/video/d5ac5b4dad", type: 'indavideo' },
                    { title: "08. rész", src: "//embed.indavideo.hu/player/video/bcf75d3a74", type: 'indavideo' },
                    { title: "09. rész", src: "//embed.indavideo.hu/player/video/7b2bfcfb8b", type: 'indavideo' },
                    { title: "10. rész", src: "//embed.indavideo.hu/player/video/e3f5985a19", type: 'indavideo' },
                    { title: "11. rész", src: "//embed.indavideo.hu/player/video/d85f2d750b", type: 'indavideo' },
                    { title: "12. rész", src: "//embed.indavideo.hu/player/video/94bb4ca873", type: 'indavideo' },
                    { title: "13. rész", src: "//embed.indavideo.hu/player/video/5e5efceb4b", type: 'indavideo' },
                    { title: "14. rész", src: "//embed.indavideo.hu/player/video/49fcdfb7bd", type: 'indavideo' },
                    { title: "15. rész", src: "//embed.indavideo.hu/player/video/f2cec55687", type: 'indavideo' },
                ]
            },
            "record-of-ragnarok-s3": {
                title: "Record of Ragnarok: Season 3",
                videos: [
                    { title: "01. rész", src: "//videa.hu/player?v=fg5MMPRNCX0ArOrR", type: 'videa' },
                    { title: "02. rész", src: "//videa.hu/player?v=ZDf2cP8SmAXsEKrU", type: 'videa' },
                    { title: "03. rész", src: "//videa.hu/player?v=CHUtrQYTZQgl6T2j", type: 'videa' },
                    { title: "04. rész", src: "//videa.hu/player?v=QogXviAtwW63DrJE", type: 'videa' },
                    { title: "05. rész", src: "//videa.hu/player?v=eJZqfRGV1qrmYVh3", type: 'videa' },
                    { title: "06. rész", src: "//videa.hu/player?v=T8R4Y0FCfUV0TOG6", type: 'videa' },
                    { title: "07. rész", src: "//videa.hu/player?v=fTxYD90gq6lKy8Ud", type: 'videa' },
                    { title: "08. rész", src: "//videa.hu/player?v=Rt3codXW3Fuo7oc4", type: 'videa' },
                    { title: "09. rész", src: "//videa.hu/player?v=VxeSoFo0dKL3Hccf", type: 'videa' },
                    { title: "10. rész", src: "//videa.hu/player?v=rEDfQlR8loKDN9qn", type: 'videa' },
                    { title: "11. rész", src: "//videa.hu/player?v=I2zmWVBtqu6w0obg", type: 'videa' },
                    { title: "12. rész", src: "//videa.hu/player?v=7Jtoc1SjPAK0ery9", type: 'videa' },
                    { title: "13. rész", src: "//videa.hu/player?v=GzkmQWEW6MrNYDZq", type: 'videa' },
                    { title: "14. rész", src: "//videa.hu/player?v=uJD5594gZbZq5q40", type: 'videa' },
                    { title: "15. rész", src: "//videa.hu/player?v=vibakbKKhkPZX3Y9", type: 'videa' }
                ]
            },
            "Evangelion": {
                title: "Neon Genesis Evangelion",
                videos: [
                    { title: "01. rész", src: "//embed.indavideo.hu/player/video/286a5eeac9", type: 'indavideo' },
                    { title: "02. rész", src: "//embed.indavideo.hu/player/video/dcb4c643c4", type: 'indavideo' },
                    { title: "03. rész", src: "//embed.indavideo.hu/player/video/729a1a303c", type: 'indavideo' },
                    { title: "04. rész", src: "//embed.indavideo.hu/player/video/0cad784310", type: 'indavideo' },
                    { title: "05. rész", src: "//embed.indavideo.hu/player/video/10982e58f7", type: 'indavideo' },
                    { title: "06. rész", src: "//embed.indavideo.hu/player/video/5c22325712", type: 'indavideo' },
                    { title: "07. rész", src: "//embed.indavideo.hu/player/video/15210731f0", type: 'indavideo' },
                    { title: "08. rész", src: "//embed.indavideo.hu/player/video/d3131c29a5", type: 'indavideo' },
                    { title: "09. rész", src: "//embed.indavideo.hu/player/video/8571557e9c", type: 'indavideo' },
                    { title: "10. rész", src: "//embed.indavideo.hu/player/video/205b9a6324", type: 'indavideo' },
                    { title: "11. rész", src: "//embed.indavideo.hu/player/video/9958e80402", type: 'indavideo' },
                    { title: "12. rész", src: "//embed.indavideo.hu/player/video/41d4d74d6a", type: 'indavideo' },
                    { title: "13. rész", src: "//embed.indavideo.hu/player/video/c9436061a6", type: 'indavideo' },
                    { title: "14. rész", src: "//embed.indavideo.hu/player/video/e651c54cdd", type: 'indavideo' },
                    { title: "15. rész", src: "//embed.indavideo.hu/player/video/b9e82c6005", type: 'indavideo' },
                    { title: "16. rész", src: "//embed.indavideo.hu/player/video/59a49ab193", type: 'indavideo' },
                    { title: "17. rész", src: "//embed.indavideo.hu/player/video/c8cddeaa1b", type: 'indavideo' },
                    { title: "18. rész", src: "//embed.indavideo.hu/player/video/a273ea4497", type: 'indavideo' },
                    { title: "19. rész", src: "//embed.indavideo.hu/player/video/f3ce246582", type: 'indavideo' },
                    { title: "20. rész", src: "//embed.indavideo.hu/player/video/e5da6af423", type: 'indavideo' },
                    { title: "21. rész", src: "//embed.indavideo.hu/player/video/77979c4cac", type: 'indavideo' },
                    { title: "22. rész", src: "//embed.indavideo.hu/player/video/9e2463619c", type: 'indavideo' },
                    { title: "23. rész", src: "//embed.indavideo.hu/player/video/99c0d5fb6b", type: 'indavideo' },
                    { title: "24. rész", src: "//embed.indavideo.hu/player/video/71cd1036af", type: 'indavideo' },
                    { title: "25. rész", src: "//embed.indavideo.hu/player/video/c1e3575648", type: 'indavideo' },
                    { title: "26. rész", src: "//embed.indavideo.hu/player/video/a1c1127501", type: 'indavideo' },


                ]
            },
            "endofevangelion": {
                title: "Neon Genesis Evangelion: The End of Evangelion",
                videos: [
                    { title: "01. rész", src: "https://vkvideo.ru/video_ext.php?oid=-234646183&id=456239019&hash=7524c94b7253d358&hd=3", type: 'vkvideo' },

                ]
            },
            "youarenotalone": {
                title: "Evangelion - 1.0 You Are (Not) Alone",
                videos: [
                    { title: "01. rész", src: "//embed.indavideo.hu/player/video/fac950fd5d", type: 'indavideo' },

                ]
            },
            "youcannotadvance": {
                title: "Evangelion - 2.0 You Can (Not) Advance",
                videos: [
                    { title: "01. rész", src: "//embed.indavideo.hu/player/video/cc72e67144", type: 'indavideo' },

                ]
            },
            "youcannotredo": {
                title: "Evangelion 3.0 You Can (Not) Redo",
                videos: [
                    { title: "01. rész", src: "https://vkvideo.ru/video_ext.php?oid=-234646183&id=456239020&hash=ac5e8053805aa170&hd=3", type: 'vkvideo' },

                ]
            },
            "thriceuponatime": {
                title: "Evangelion: 3.0+1.0 Thrice Upon a Time",
                videos: [
                    { title: "01. rész", src: "//embed.indavideo.hu/player/video/7b69d8bfb6", type: 'indavideo' },

                ]
            },
            "infinitedarkness": {
                title: "Resident Evil: Infinite Darkness",
                videos: [
                    { title: "01. rész", src: "///videa.hu/player?v=oVHAEHEE60URUsdG", type: 'videa' },
                    { title: "02. rész", src: "//videa.hu/player?v=sE41KsoAgb30Pd33", type: 'videa' },
                    { title: "03. rész", src: "//videa.hu/player?v=H96WiG6MlfGIs1Lb", type: 'videa' },
                    { title: "04. rész", src: "//videa.hu/player?v=kb7Dp5ZV0AuPINTe", type: 'videa' },


                ]
            },
            "degeneration": {
                title: "Resident Evil: Degeneration",
                videos: [
                    { title: "01. rész", src: "https://vkvideo.ru/video_ext.php?oid=-234646183&id=456239021&hash=07ac20bef7a9f659&hd=3", type: 'vkvideo' },

                ]
            },

            "damnation": {
                title: "Resident Evil: Damnation",
                videos: [
                    { title: "01. rész", src: "https://vkvideo.ru/video_ext.php?oid=-234646183&id=456239022&hash=fcd3a516e4019856&hd=3", type: 'vkvideo' },

                ]
            },

            "vendetta": {
                title: "Resident Evil: Vendetta",
                videos: [
                    { title: "01. rész", src: "https://vkvideo.ru/video_ext.php?oid=-234646183&id=456239023&hash=01ba2a83353b4699&hd=3", type: 'vkvideo' },

                ]
            },

            "deathisland": {
                title: "Resident Evil: Death Island",
                videos: [
                    { title: "01. rész", src: "https://vkvideo.ru/video_ext.php?oid=-234646183&id=456239024&hash=e03590ee5b52ea5e&hd=3", type: 'vkvideo' },

                ]
            },
            "fallouts1": {
                title: "Fallout Season 1 ",
                videos: [
                    { title: "01. rész", src: "https://vkvideo.ru/video_ext.php?oid=-234646183&id=456239025&hash=e20f7022cea7f813&hd=3", type: 'vkvideo' },
                    { title: "02. rész", src: "https://vkvideo.ru/video_ext.php?oid=-234646183&id=456239026&hash=f8fbd6f05da7cbbe&hd=3", type: 'vkvideo' },
                    { title: "03. rész", src: "https://vkvideo.ru/video_ext.php?oid=-234646183&id=456239027&hash=6dc97bb26e8fa3ae&hd=3", type: 'vkvideo' },
                    { title: "04. rész", src: "https://vkvideo.ru/video_ext.php?oid=-234646183&id=456239028&hash=ceeaece9ea553490&hd=3", type: 'vkvideo' },
                    { title: "05. rész", src: "https://vkvideo.ru/video_ext.php?oid=-234646183&id=456239029&hash=b5c0aebb6665db03&hd=3", type: 'vkvideo' },
                    { title: "06. rész", src: "https://vkvideo.ru/video_ext.php?oid=-234646183&id=456239030&hash=528b6f22b4f75bf8&hd=3", type: 'vkvideo' },
                    { title: "07. rész", src: "https://vkvideo.ru/video_ext.php?oid=-234646183&id=456239031&hash=2d09bbd791943ff0&hd=3", type: 'vkvideo' },
                    { title: "08. rész", src: "https://vkvideo.ru/video_ext.php?oid=-234646183&id=456239032&hash=bae0897cec8e331d&hd=3", type: 'vkvideo' },
                ]
            },
            "fallouts2": {
                title: "Fallout Season 2",
                videos: [
                    { title: "01. rész", src: "//videa.hu/player?v=NQqeibn88zZ278TD", type: 'videa' },

                ]
            },
        };


        function revealMsg(node, text, type = "") { if (!node) return; node.textContent = text; node.className = "form-msg" + (type ? " " + type : ""); }

        function checkTitleOverflow() {
            document.querySelectorAll('.series-title').forEach(titleDiv => {
                const titleSpan = titleDiv.querySelector('span');

                titleDiv.classList.remove('scrolling-title');

                if (titleSpan.scrollWidth > titleDiv.clientWidth) {
                    titleDiv.classList.add('scrolling-title');
                }
            });
        }

        async function saveProgress(seriesKey, videoIndex) {
            const user = auth.currentUser;
            if (!user) return;
            const progressRef = ref(db, `progress/${user.uid}/${seriesKey}`);
            try {
                await set(progressRef, {
                    index: videoIndex,
                    timestamp: Date.now()
                });
            } catch (error) {
                console.error("Hiba a progress mentésekor:", error);
            }
        }

        async function loadProgress(seriesKey) {
            const user = auth.currentUser;
            if (!user) return 0;

            const dbRef = ref(db);
            try {
                const snapshot = await get(child(dbRef, `progress/${user.uid}/${seriesKey}`));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    return data.index !== undefined ? data.index : 0;
                } else {
                    return 0;
                }
            } catch (error) {
                console.error("Hiba a progress betöltésekor:", error);
                return 0;
            }
        }

        function loadAllProgress() {
            const user = auth.currentUser;
            if (!user) return;

            const progressRef = ref(db, `progress/${user.uid}`);

            onValue(progressRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    allProgressData = data;
                    populateWatchedList(data);
                } else {
                    watchedList.innerHTML = '<p style="font-size: 0.85rem; color: #777;">Még nem néztél sorozatot.</p>';
                    allProgressData = {};
                }
            }, {
                onlyOnce: true
            });
        }

        function populateWatchedList(progressData) {
            if (!progressData || Object.keys(progressData).length === 0) {
                watchedList.innerHTML = '<p style="font-size: 0.85rem; color: #777;">Még nem néztél sorozatot.</p>';
                return;
            }

            const watchedItems = Object.keys(progressData)
                .map(seriesKey => {
                    const data = progressData[seriesKey];

                    if (data.index === undefined || data.index < 0) return null;

                    const seriesInfo = seriesData[seriesKey];

                    if (!seriesInfo) return null;

                    return {
                        seriesKey,
                        title: seriesInfo.title,
                        watchedIndex: data.index,
                        totalEpisodes: seriesInfo.videos.length,
                        timestamp: data.timestamp || 0
                    };
                })
                .filter(item => item !== null);

            watchedItems.sort((a, b) => b.timestamp - a.timestamp);

            const limitedItems = watchedItems.slice(0, 5);

            watchedList.innerHTML = '';

            if (limitedItems.length === 0) {
                watchedList.innerHTML = '<p style="font-size: 0.85rem; color: #777;">Még nem néztél sorozatot.</p>';
                return;
            }


            limitedItems.forEach(item => {
                const { seriesKey, title, watchedIndex, totalEpisodes } = item;
                const watchedCount = Math.min(watchedIndex + 1, totalEpisodes);

                let progressText;
                if (totalEpisodes === 1) {
                    progressText = `Film`;
                } else {
                    progressText = (watchedCount >= totalEpisodes) ?
                        `Befejezve: ${totalEpisodes}/${totalEpisodes}` :
                        `${watchedCount}/${totalEpisodes} rész (${seriesData[seriesKey].videos[watchedIndex].title})`;
                }

                const progressBarWidth = (watchedCount / totalEpisodes) * 100;

                const itemDiv = document.createElement('div');
                itemDiv.classList.add('watched-item');
                itemDiv.dataset.series = seriesKey;

                itemDiv.innerHTML = `
                    <div class="watched-title">${title}</div>
                    <div class="watched-progress-text">${progressText}</div>
                    <div class="progress-container" style="margin-top: 5px;">
                        <div class="progress-bar" style="width: ${progressBarWidth}%;"></div>
                    </div>
                `;

                itemDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.style.display = 'none';

                    loadSeries(seriesKey);
                    mainPage.style.display = 'none';
                    seriesPage.style.display = 'flex';
                });

                watchedList.appendChild(itemDiv);
            });
        }


        // Login
        loginForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            revealMsg(loginMsg, "");
            const email = document.getElementById("loginEmail").value.trim();
            const pass = document.getElementById("loginPassword").value;
            if (!email || !pass) return revealMsg(loginMsg, "Tölts ki minden mezőt!", "error");
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                revealMsg(loginMsg, "❌ Hibás e-mail vagy jelszó.", "error");
                console.error(err);
            }
        });

        // Logout
        logoutBtn.addEventListener("click", async () => { await signOut(auth); });

        // Profile dropdown toggle
        profileBtn.addEventListener("click", (e) => {
            e.stopPropagation();

            if (profileDropdown.style.display !== "block") {
                loadAllProgress();
            }

            profileDropdown.style.display = profileDropdown.style.display === "block" ? "none" : "block";
        });

        // GLOBÁLIS KATTINTÁSKEZELŐ (MENÜ ÉS KERESŐ BEZÁRÁSA)
        document.addEventListener('click', (e) => {
            const isClickInsideDropdown = profileDropdown.contains(e.target);
            const isClickOnProfileButton = profileBtn.contains(e.target);

            const isClickInsideSearch = searchContainer.contains(e.target);
            const isClickOnSearchButton = searchBtn.contains(e.target);

            if (profileDropdown.style.display === 'block' && !isClickInsideDropdown && !isClickOnProfileButton) {
                profileDropdown.style.display = 'none';
            }

            if (searchContainer.classList.contains('active') && !isClickInsideSearch && !isClickOnSearchButton) {
                if (searchInput.value.length === 0) {
                    searchContainer.classList.remove('active');
                    searchInput.blur();
                }
            }
        });


        // Auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginContainer.style.display = "none";

                appContainer.style.display = "flex";

                setTimeout(() => {
                    appContainer.style.opacity = "1";
                }, 10);

                const displayId = user.displayName || user.email.split('@')[0];
                usernameDisplay.textContent = displayId;
                profileName.textContent = displayId;
                profileEmail.textContent = user.email;
                setTimeout(checkTitleOverflow, 500);

                loadAllProgress();

            } else {
                appContainer.style.opacity = "0";
                appContainer.style.display = "none";
                loginContainer.style.display = "flex";
                profileDropdown.style.display = "none";
            }
        });

        // Series card click
        document.querySelectorAll('.series-card').forEach(card => {
            card.addEventListener('click', async () => {
                const seriesKey = card.getAttribute('data-series');
                await loadSeries(seriesKey);
                mainPage.style.display = 'none';
                seriesPage.style.display = 'flex';
            });
        });

        // Home click
       // Home click
        homeBtn.addEventListener('click', () => {
            seriesPage.style.display = 'none';
            mainPage.style.display = 'flex';
            searchBtn.style.display = 'flex';
            searchContainer.classList.remove('active');
            searchInput.value = '';
            document.querySelectorAll('.series-card').forEach(card => card.style.display = 'flex');
            videoContainer.innerHTML = '';
            videoList.innerHTML = '';
            nextEpisodeBtn.style.display = 'none';

            // EZEKET MÁSOLD IDE:
            dynamicBackground.style.backgroundImage = 'none';
            dynamicBackground.classList.remove('visible');
            appContainer.classList.remove('active-bg');

            setTimeout(checkTitleOverflow, 100);
        });

        // Back button
// Back button
        backBtn.addEventListener('click', () => {
            seriesPage.style.display = 'none';
            mainPage.style.display = 'flex';
            searchBtn.style.display = 'flex';
            searchContainer.classList.remove('active');
            videoContainer.innerHTML = '';
            videoList.innerHTML = '';
            nextEpisodeBtn.style.display = 'none';

            // EZEKET MÁSOLD IDE:
            dynamicBackground.style.backgroundImage = 'none';
            dynamicBackground.classList.remove('visible');
            appContainer.classList.remove('active-bg');

            setTimeout(checkTitleOverflow, 100);
        });
        // Search functionality
        searchBtn.addEventListener('click', (e) => {
            e.stopPropagation();

            if (searchContainer.classList.contains('active')) {
                if (searchInput.value.length > 0) {
                    searchInput.focus();
                } else {
                    searchContainer.classList.remove('active');
                    searchInput.blur();
                }
            } else {
                searchContainer.classList.add('active');
                searchInput.focus();
            }
        });

        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            searchClearBtn.style.display = query.length > 0 ? 'block' : 'none';
            document.querySelectorAll('.series-card').forEach(card => {
                const titleElement = card.querySelector('.series-title span');
                if (titleElement) {
                    const title = titleElement.textContent.toLowerCase();
                    card.style.display = title.includes(query) ? 'flex' : 'none';
                } else {
                    card.style.display = 'none';
                }
            });
            setTimeout(checkTitleOverflow, 10);
        });

        // Törlés gomb funkció
        searchClearBtn.addEventListener('click', () => {
            searchInput.value = '';
            searchClearBtn.style.display = 'none';
            searchInput.focus();
            document.querySelectorAll('.series-card').forEach(card => card.style.display = 'flex');
            setTimeout(checkTitleOverflow, 10);
        });
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkTitleOverflow, 500);
        });

        document.addEventListener('keydown', function (e) {
            if (e.key === "F12") e.preventDefault();
            if (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "C")) e.preventDefault();
            if (e.ctrlKey && (e.key === "u" || e.key === "s")) e.preventDefault();
        });


        // FRISSÍTETT UPDATEPLAYER FÜGGVÉNY
        function updatePlayer(src, type) {
            const videoContainer = document.querySelector('.video-frame-container');
            videoContainer.innerHTML = '';

            const iframe = document.createElement('iframe');
            iframe.allowFullscreen = true;
            iframe.scrolling = 'no';
            iframe.width = '100%';
            iframe.height = '100%';
            iframe.src = src;
            iframe.frameBorder = '0';
            iframe.allow = 'autoplay; fullscreen';

            if (type === 'indavideo') {
                iframe.title = 'indavideo video player';
                iframe.classList.add('indavideo-player');
            } else if (type === 'videa' || type === 'vkvideo') {
                iframe.webkitallowfullscreen = true;
                iframe.mozallowfullscreen = true;
            }

            videoContainer.appendChild(iframe);
        }

async function loadSeries(seriesKey) {
    const series = seriesData[seriesKey];
    if (!series) return;

    // UI tisztítás
    searchContainer.classList.remove('active');
    searchBtn.style.display = 'none';
    seriesTitle.textContent = series.title;
    videoList.innerHTML = "";
    nextEpisodeBtn.style.display = 'none';

    // DINAMIKUS HÁTTÉRKÉP BEÁLLÍTÁSA
    const seriesCardImg = document.querySelector(`.series-card[data-series="${seriesKey}"] img`);
    if (seriesCardImg && seriesCardImg.src) {
        dynamicBackground.style.backgroundImage = `url('${seriesCardImg.src}')`;
        dynamicBackground.classList.add('visible');
    }

    const lastWatchedIndex = await loadProgress(seriesKey);
    const totalEpisodes = series.videos.length;
    const initialIndex = Math.min(lastWatchedIndex, totalEpisodes - 1);

    if (totalEpisodes > 0) {
        updatePlayer(series.videos[initialIndex].src, series.videos[initialIndex].type);
    }

    series.videos.forEach((vid, index) => {
        const card = document.createElement('div');
        card.classList.add('video-card');
        card.textContent = vid.title;

        if (index === initialIndex) card.classList.add('active');

        card.addEventListener('click', () => {
            updatePlayer(vid.src, vid.type);
            document.querySelectorAll('.video-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');
            saveProgress(seriesKey, index);
            updateNextEpisodeButton(seriesKey, index + 1);
        });
        videoList.appendChild(card);
    });

    updateNextEpisodeButton(seriesKey, initialIndex + 1);
}

        // MÓDOSÍTOTT SEGÉDFÜGGVÉNY: Következő epizód gomb frissítése
        function updateNextEpisodeButton(seriesKey, nextIndex) {
            const series = seriesData[seriesKey];
            const totalEpisodes = series.videos.length;

            if (nextIndex < totalEpisodes) {
                const nextVideo = series.videos[nextIndex];
                nextEpisodeBtn.textContent = `Következő epizód: ${nextVideo.title}`;
                nextEpisodeBtn.style.display = 'flex';

                nextEpisodeBtn.onclick = () => {
                    const nextCard = document.querySelector(`.video-card[data-index="${nextIndex}"]`);
                    if (nextCard) {
                        nextCard.click();
                    }
                };

            } else {
                if (totalEpisodes === 1) {
                    nextEpisodeBtn.style.display = 'none';
                    nextEpisodeBtn.onclick = null;
                } else {
                    nextEpisodeBtn.textContent = `A sorozat befejezve!`;
                    nextEpisodeBtn.style.display = 'flex';
                    nextEpisodeBtn.onclick = null;
                }
            }
        }
    </script>
</body>

</html>
