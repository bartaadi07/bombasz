<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>BOMBASZ - Social</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #050505;
            --ink: #FFFFFF;
            --ink-muted: #A0A0A0;
            --border: rgba(255, 255, 255, 0.2);
            --neon-green: #4bff4b;
            --radius: 4px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        html, body { height: 100%; font-family: 'Poppins', sans-serif; background-color: var(--bg-dark); color: var(--ink); overflow: hidden; }

        .noselect { -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }

        /* --- LOGIN STYLES --- */
        #login-view { position: absolute; inset: 0; z-index: 2000; display: flex; justify-content: center; align-items: center; background: var(--bg-dark); }
        .bg-wrap { position: absolute; inset: 0; z-index: -1; background: linear-gradient(rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.9)), repeating-linear-gradient(0deg, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 50px), repeating-linear-gradient(90deg, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 50px); background-size: 50px 50px; animation: bg-zoom 20s infinite alternate linear; }
        @keyframes bg-zoom { from { background-position: 0 0; } to { background-position: 50px 50px; } }
        .login-container { width: 100%; max-width: 420px; padding: 20px; position: relative; z-index: 2; }
        .main-title { font-family: 'Orbitron', sans-serif; font-size: clamp(2rem, 6vw, 3rem); font-weight: 900; text-align: center; margin-bottom: 2rem; animation: title-pulse 2s infinite alternate; letter-spacing: 0.1em; text-shadow: 0 0 15px rgba(255,255,255,0.1); }
        @keyframes title-pulse { from { opacity: 0.8; transform: scale(1); } to { opacity: 1; transform: scale(1.02); } }
        .form-card { background: rgba(20, 20, 20, 0.95); border: 1px solid var(--border); padding: 30px; border-radius: var(--radius); box-shadow: 0 0 40px rgba(0,0,0,0.8); backdrop-filter: blur(10px); }
        .auth-tabs { display: flex; margin-bottom: 25px; border-bottom: 1px dashed var(--ink-muted); }
        .auth-tab { flex: 1; padding: 12px; background: transparent; border: none; color: var(--ink-muted); font-family: 'Orbitron'; font-weight: 700; text-transform: uppercase; cursor: pointer; transition: all 0.3s; border-bottom: 2px solid transparent; margin-bottom: -1px; }
        .auth-tab.active, .auth-tab:hover { color: var(--ink); border-bottom-color: var(--ink); }
        .auth-form { display: none; }
        .auth-form.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; color: var(--ink-muted); font-size: 0.8rem; margin-bottom: 6px; }
        .form-group input { width: 100%; padding: 12px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius); color: #fff; font-family: 'Poppins'; transition: 0.3s; }
        .form-group input:focus { outline: none; border-color: var(--ink); background: rgba(255,255,255,0.1); }
        .checkbox-group { display: flex; align-items: center; gap: 10px; margin: 18px 0; cursor: pointer; }
        .checkbox-group input { width: 16px; height: 16px; cursor: pointer; accent-color: var(--ink); }
        .checkbox-group label { color: var(--ink-muted); font-size: 0.8rem; cursor: pointer; }
        .submit-btn { width: 100%; padding: 14px; background: var(--ink); color: #000; border: none; border-radius: var(--radius); font-family: 'Orbitron'; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: 0.3s; }
        .submit-btn:hover { background: #ddd; transform: translateY(-2px); }
        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .forgot-link { display: block; text-align: center; margin-top: 15px; color: var(--ink-muted); font-size: 0.8rem; text-decoration: none; }
        .forgot-link:hover { color: #fff; }
        .message { padding: 10px; margin-bottom: 15px; border-radius: var(--radius); font-size: 0.85rem; font-weight: 600; display: none; text-align: center; }
        .message.error { display: block; background: rgba(255, 68, 68, 0.2); border: 1px solid #ff4444; color: #ff4444; }
        .message.success { display: block; background: rgba(75, 255, 75, 0.2); border: 1px solid #4bff4b; color: #4bff4b; }

        /* --- APP VIEW STYLES --- */
        #app-view { display: none; flex-direction: column; width: 100%; height: 100%; position: relative; z-index: 10; }
        .main-header { height: 60px; padding: 0 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 100; flex-shrink: 0; }
        .user-profile-side { display: flex; align-items: center; gap: 10px; }
        .profile-icon { width: 28px; height: 28px; background: #fff; color: #000; display: flex; align-items: center; justify-content: center; border-radius: 5px; font-weight: bold; font-family: 'Orbitron'; font-size: 0.7rem; }
        .container { height: calc(100% - 60px); display: flex; position: relative; width: 100%; overflow: hidden; }
        .social-wrapper { display: flex; width: 100%; height: 100%; position: relative; }
        .social-sidebar { width: 350px; background: #0a0a0a; border-right: 1px solid var(--border); padding: 15px; display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; transition: all 0.3s ease; }
        .chat-container { flex-grow: 1; background: #000; display: flex; flex-direction: column; position: relative; height: 100%; }
        .section-title { font-family: 'Orbitron'; font-size: 0.6rem; color: #555; margin: 20px 0 10px; text-transform: uppercase; letter-spacing: 1.5px; }
        
        .search-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); padding: 10px; color: #fff; font-family: 'Orbitron'; margin-bottom: 15px; outline: none; font-size: 0.75rem; border-radius: 4px; }
        
        .user-card { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.02); margin-bottom: 5px; border-radius: 4px; transition: 0.2s; }
        .user-card:hover { background: rgba(255,255,255,0.08); }
        .user-info-click { flex-grow: 1; cursor: pointer; display:flex; align-items:center; justify-content: space-between; }
        
        .btn-action { background: none; border: 1px solid #444; color: #fff; padding: 4px 8px; font-family: 'Orbitron'; font-size: 0.55rem; cursor: pointer; border-radius: 2px; }
        
        .btn-icon-logout { background: transparent; border: none; color: #fff; font-size: 1.2rem; cursor: pointer; padding: 8px; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
        .btn-icon-logout:hover { color: #ff4444; transform: scale(1.1); }

        /* Notification Enable Button */
        .btn-notif { background: transparent; border: 1px solid #4bff4b; color: #4bff4b; font-size: 1rem; cursor: pointer; padding: 8px 12px; margin-right: 10px; border-radius: 4px; transition: 0.3s; display: flex; align-items: center; gap: 6px; }
        .btn-notif:hover { background: rgba(75, 255, 75, 0.1); }
        .btn-notif.enabled { border-color: #4bff4b; color: #4bff4b; }
        .btn-notif.denied { border-color: #ff4444; color: #ff4444; }
        .btn-notif.unsupported { border-color: #666; color: #666; }
        .btn-notif i { font-size: 0.9rem; }

        /* --- CHAT HEADER --- */
        #chat-target-name { height: 50px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: rgba(255,255,255,0.03); font-family: 'Orbitron'; font-size: 0.75rem; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .chat-header-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px; }
        .chat-header-actions { display: none; flex-shrink: 0; gap: 5px; }
        .btn-header-icon { background: transparent; border: 1px solid transparent; color: #fff; font-size: 0.9rem; cursor: pointer; padding: 6px; border-radius: 4px; transition: 0.3s; }
        .btn-header-icon:hover { background: rgba(255,255,255,0.1); }

        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .message-wrapper { display: flex; align-items: center; gap: 8px; max-width: 80%; }
        .message-wrapper.sent { align-self: flex-end; flex-direction: row-reverse; }
        .message-wrapper.received { align-self: flex-start; }

        .message-bubble { padding: 10px 14px; font-size: 0.85rem; border-radius: 4px; line-height: 1.4; word-wrap: break-word; position: relative; cursor: pointer; transition: transform 0.1s; }
        .message-bubble:active { transform: scale(0.98); }
        .message-bubble.sent { background: #fff; color: #000; }
        .message-bubble.received { background: rgba(255,255,255,0.1); border: 1px solid var(--border); color: #fff; }

        .msg-options-pc { display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s; }
        .message-wrapper:hover .msg-options-pc { opacity: 1; }
        .btn-msg-icon { color: #555; cursor: pointer; font-size: 0.8rem; padding: 4px; transition: 0.2s; }
        .btn-msg-icon:hover { color: #fff; transform: scale(1.1); }
        .btn-msg-icon.delete:hover { color: #ff4444; }

        .chat-input-wrapper { padding: 10px; background: #0a0a0a; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        #msg-input { flex-grow: 1; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 4px; outline: none; }
        .btn-send { background: #fff; border: none; padding: 0 20px; font-family: 'Orbitron'; font-weight: 900; font-size: 0.7rem; cursor: pointer; border-radius: 4px; }
        .mobile-back { display: none; background: none; border: none; color: #fff; font-size: 1.2rem; cursor: pointer; padding-right: 15px; }
        
        #toast-container { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 300px; }
        .toast { background: #fff; color: #000; padding: 10px 20px; border-radius: 4px; font-family: 'Orbitron'; font-size: 0.65rem; font-weight: 900; margin-bottom: 5px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

        .unread-badge { width: 8px; height: 8px; background: #fff; border-radius: 50%; display: inline-block; margin-right: 10px; box-shadow: 0 0 5px rgba(255,255,255,0.8); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.7; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0.7; transform: scale(1); } }

        .modal-overlay { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal-box { background: #111; border: 1px solid #333; padding: 25px; border-radius: 12px; width: 90%; max-width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: scale(0.9); transition: 0.3s; }
        .modal-overlay.open .modal-box { transform: scale(1); }
        .modal-text { font-size: 0.9rem; margin-bottom: 20px; color: #ddd; line-height: 1.5; }
        .modal-input { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: #fff; margin-bottom: 20px; border-radius: 4px; outline: none; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .btn-modal { padding: 8px 20px; border-radius: 4px; border: none; font-family: 'Orbitron'; font-size: 0.7rem; cursor: pointer; flex: 1; }
        .btn-modal-cancel { background: transparent; border: 1px solid #555; color: #aaa; }
        .btn-modal-confirm { background: #fff; color: #000; font-weight: bold; }
        .btn-modal-delete { background: #330000; color: #ff4444; border: 1px solid #ff4444; }
        .btn-modal-copy { background: #003300; color: #4bff4b; border: 1px solid #4bff4b; }

        @media (max-width: 768px) {
            .social-sidebar { width: 100%; position: absolute; left: 0; top: 0; height: 100%; z-index: 10; }
            .chat-container { width: 100%; position: absolute; left: 100%; top: 0; height: 100%; z-index: 20; transition: left 0.3s ease; }
            body.chat-open .chat-container { left: 0; }
            body.chat-open .mobile-back { display: block; }
            .msg-options-pc { display: none; } 
            .btn-notif span { display: none; }
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body id="body-tag">

    <div id="toast-container"></div>
    
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <div id="modal-text" class="modal-text">Biztosan?</div>
            <div class="modal-buttons">
                <button id="modal-cancel-btn" class="btn-modal btn-modal-cancel">Mégse</button>
                <button id="modal-confirm-btn" class="btn-modal btn-modal-confirm">Igen</button>
            </div>
        </div>
    </div>

    <div id="msg-actions-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-text">Válassz műveletet</div>
            <div class="modal-buttons" style="flex-direction:column; gap:10px;">
                <button id="msg-act-copy" class="btn-modal btn-modal-copy">Másolás</button>
                <button id="msg-act-delete" class="btn-modal btn-modal-delete">Törlés</button>
                <button id="msg-act-cancel" class="btn-modal btn-modal-cancel">Mégse</button>
            </div>
        </div>
    </div>

    <div id="input-modal" class="modal-overlay">
        <div class="modal-box">
            <div id="input-modal-title" class="modal-text" style="font-weight:bold; margin-bottom:10px;">Cím</div>
            <input type="text" id="input-modal-field" class="modal-input" autocomplete="off">
            <div class="modal-buttons">
                <button id="input-modal-cancel" class="btn-modal btn-modal-cancel">Mégse</button>
                <button id="input-modal-confirm" class="btn-modal btn-modal-confirm">Mentés</button>
            </div>
        </div>
    </div>

    <div id="login-view">
        <div class="bg-wrap"></div>
        <div class="login-container">
            <h1 class="main-title">BOMBASZ</h1>
            <div class="form-card">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login">Bejelentkezés</button>
                    <button class="auth-tab" data-tab="register">Regisztráció</button>
                </div>
                <div id="auth-message" class="message"></div>
                <form id="login-form" class="auth-form active">
                    <div class="form-group"><label for="login-email">Email cím</label><input type="email" id="login-email" placeholder="pelda@email.com" required></div>
                    <div class="form-group"><label for="login-password">Jelszó</label><input type="password" id="login-password" placeholder="••••••••" required></div>
                    <div class="checkbox-group"><input type="checkbox" id="remember-me" checked><label for="remember-me">Emlékezz rám</label></div>
                    <button type="submit" class="submit-btn">Belépés</button>
                    <a href="#" class="forgot-link" id="forgot-password">Elfelejtetted a jelszavad?</a>
                </form>
                <form id="register-form" class="auth-form">
                    <div class="form-group"><label for="reg-username">Felhasználónév</label><input type="text" id="reg-username" placeholder="Pl. Gamer123" required></div>
                    <div class="form-group"><label for="register-email">Email cím</label><input type="email" id="register-email" placeholder="pelda@email.com" required></div>
                    <div class="form-group"><label for="register-password">Jelszó</label><input type="password" id="register-password" placeholder="Min. 6 karakter" required minlength="6"></div>
                    <div class="form-group"><label for="register-password2">Jelszó újra</label><input type="password" id="register-password2" placeholder="Jelszó megerősítése" required minlength="6"></div>
                    <button type="submit" class="submit-btn">Regisztráció</button>
                </form>
            </div>
        </div>
    </div>

    <div id="app-view">
        <header class="main-header">
            <button class="mobile-back" onclick="closeChat()"><i class="fa-solid fa-arrow-left"></i></button>
            <div class="user-profile-side" id="header-user-info"><div class="profile-icon">?</div></div>
            <div style="display:flex; align-items:center;">
                <button id="notif-btn" class="btn-notif" onclick="requestNotificationPermission()" title="Értesítések engedélyezése">
                    <i class="fa-solid fa-bell"></i>
                    <span>Értesítések</span>
                </button>
                <button onclick="logoutUser()" class="btn-icon-logout" title="Kijelentkezés"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </header>

        <main class="container">
            <div class="social-wrapper">
                <aside class="social-sidebar" id="sidebar">
                    <input type="text" id="user-search" class="search-input" placeholder="KERESÉS..." autocomplete="off">
                    <div id="search-results"></div>

                    <div class="section-title">Kérések <span id="req-count" style="color:red; display:none">!</span></div>
                    <div id="requests-list"></div>

                    <div class="section-title">Barátok</div>
                    <div id="friends-list"></div>
                </aside>

                <section class="chat-container" id="chat-window">
                    <div id="chat-target-name">
                        <span id="active-chat-user" class="chat-header-title">VÁLASSZ VALAKIT</span>
                        <div id="chat-actions" class="chat-header-actions">
                            <button id="rename-friend-btn" class="btn-header-icon" title="Becenév beállítása"><i class="fa-solid fa-pen"></i></button>
                            <button id="delete-friend-btn" class="btn-header-icon" title="Beszélgetés törlése"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    
                    <div id="chat-messages"></div>
                    <div class="chat-input-wrapper">
                        <input type="text" id="msg-input" placeholder="Üzenet..." autocomplete="off">
                        <button id="send-btn" class="btn-send"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, setPersistence, browserLocalPersistence, browserSessionPersistence, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, remove, serverTimestamp, onDisconnect, update, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAwRrAtHaNRh2DLwVkryA3wSf86h7aQCaI",
            authDomain: "konyv-93c63.firebaseapp.com",
            databaseURL: "https://konyv-93c63-default-rtdb.firebaseio.com",
            projectId: "konyv-93c63",
            storageBucket: "konyv-93c63.firebasestorage.app",
            messagingSenderId: "308577632498",
            appId: "1:308577632498:web:yourappid"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUid, currentUsername, activeChatId;
        const appStartTime = Date.now(); 
        
        let currentChatFriendUid = null;
        let currentChatOriginalName = null;
        let unreadStates = {}; 

        // ========================================
        // NOTIFICATION SYSTEM (Böngésző API)
        // ========================================
        
        function updateNotifButton() {
            const btn = document.getElementById('notif-btn');
            if (!btn) return;
            
            if (!('Notification' in window)) {
                btn.innerHTML = '<i class="fa-solid fa-bell-slash"></i><span>Nem támogatott</span>';
                btn.className = 'btn-notif unsupported';
                btn.disabled = true;
                return;
            }
            
            const perm = Notification.permission;
            if (perm === 'granted') {
                btn.innerHTML = '<i class="fa-solid fa-bell"></i><span>Bekapcsolva</span>';
                btn.className = 'btn-notif enabled';
            } else if (perm === 'denied') {
                btn.innerHTML = '<i class="fa-solid fa-bell-slash"></i><span>Tiltva</span>';
                btn.className = 'btn-notif denied';
                btn.title = 'Engedélyezd a böngésző beállításaiban';
            } else {
                btn.innerHTML = '<i class="fa-solid fa-bell"></i><span>Értesítések</span>';
                btn.className = 'btn-notif';
            }
        }
        
        window.requestNotificationPermission = async function() {
            if (!('Notification' in window)) {
                showToast('A böngésződ nem támogatja az értesítéseket');
                return;
            }
            
            if (Notification.permission === 'denied') {
                showToast('Értesítések tiltva! Engedélyezd a böngésző beállításaiban.');
                return;
            }
            
            if (Notification.permission === 'granted') {
                showToast('Értesítések már engedélyezve!');
                return;
            }
            
            const permission = await Notification.requestPermission();
            updateNotifButton();
            
            if (permission === 'granted') {
                showToast('Értesítések bekapcsolva!');
            } else {
                showToast('Értesítések elutasítva');
            }
        };
        
        function sendNotification(title, body) {
            if (Notification.permission === 'granted' && document.hidden) {
                try {
                    const notif = new Notification(title, {
                        body: body,
                        icon: 'img/icon-192.png',
                        tag: 'bombasz-msg-' + Date.now(),
                        renotify: true
                    });
                    
                    notif.onclick = () => {
                        window.focus();
                        notif.close();
                    };
                    
                    setTimeout(() => notif.close(), 5000);
                } catch (e) {
                    console.log('Notification error:', e);
                }
            }
        }

        // ========================================
        // MODALS
        // ========================================
        
        function showConfirm(text, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('modal-text').innerText = text;
            modal.classList.add('open');
            document.getElementById('modal-confirm-btn').onclick = () => { modal.classList.remove('open'); onConfirm(); };
            document.getElementById('modal-cancel-btn').onclick = () => { modal.classList.remove('open'); };
        }

        function showInput(title, placeholder, onConfirm) {
            const modal = document.getElementById('input-modal');
            const input = document.getElementById('input-modal-field');
            document.getElementById('input-modal-title').innerText = title;
            input.value = "";
            input.placeholder = placeholder;
            modal.classList.add('open');
            input.focus();

            document.getElementById('input-modal-confirm').onclick = () => {
                const val = input.value.trim();
                modal.classList.remove('open');
                if(val) onConfirm(val);
            };
            document.getElementById('input-modal-cancel').onclick = () => { modal.classList.remove('open'); };
        }

        function showMessageOptions(msgId, text, isMine) {
            const modal = document.getElementById('msg-actions-modal');
            const btnCopy = document.getElementById('msg-act-copy');
            const btnDelete = document.getElementById('msg-act-delete');
            const btnCancel = document.getElementById('msg-act-cancel');

            btnDelete.style.display = isMine ? 'block' : 'none';
            modal.classList.add('open');

            btnCopy.onclick = () => {
                navigator.clipboard.writeText(text).then(() => showToast("Másolva!"));
                modal.classList.remove('open');
            };

            if (isMine) {
                btnDelete.onclick = () => {
                    modal.classList.remove('open');
                    deleteMessage(msgId);
                };
            }
            btnCancel.onclick = () => modal.classList.remove('open');
        }

        function addLongPressEvent(element, callback) {
            let timer;
            const start = () => { timer = setTimeout(callback, 600); };
            const cancel = () => { clearTimeout(timer); };
            element.addEventListener('touchstart', start);
            element.addEventListener('touchend', cancel);
            element.addEventListener('touchmove', cancel);
            element.addEventListener('mousedown', start);
            element.addEventListener('mouseup', cancel);
            element.addEventListener('mouseleave', cancel);
        }

        // --- KERESÉS ---
        const searchInput = document.getElementById('user-search');
        const searchResults = document.getElementById('search-results');
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.innerHTML = '';
            }
        });

        searchInput.addEventListener('input', (e) => {
            const val = e.target.value.trim().toLowerCase();
            const friendCards = document.querySelectorAll('#friends-list .user-card');
            friendCards.forEach(card => {
                const name = card.getAttribute('data-name')?.toLowerCase() || '';
                card.style.display = name.includes(val) ? 'flex' : 'none';
            });

            if (val.length < 2) { searchResults.innerHTML = ''; return; }
            onValue(ref(db, 'users'), (snap) => {
                const users = snap.val(); let h = '';
                for (let uid in users) {
                    const n = users[uid].username || users[uid].email.split('@')[0];
                    if (uid !== currentUid && n.toLowerCase().includes(val)) {
                        h += `<div class="user-card" style="border:1px dashed #444"><span>${n}</span><button class="btn-action" onclick="sendRequest('${uid}', '${n}')">JELÖLÉS</button></div>`;
                    }
                }
                searchResults.innerHTML = h;
            }, { onlyOnce: true });
        });

        // --- AUTH UI ---
        const tabs = document.querySelectorAll('.auth-tab'); 
        const forms = document.querySelectorAll('.auth-form');
        function showAuthMessage(text, type) { const msg = document.getElementById('auth-message'); msg.textContent = text; msg.className = `message ${type}`; }
        function hideAuthMessage() { document.getElementById('auth-message').className = 'message'; }
        tabs.forEach(tab => { tab.addEventListener('click', () => { tabs.forEach(t => t.classList.remove('active')); forms.forEach(f => f.classList.remove('active')); tab.classList.add('active'); document.getElementById(`${tab.dataset.tab}-form`).classList.add('active'); hideAuthMessage(); }); });
        window.showToast = function(msg) { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = 'toast'; t.innerText = msg; c.appendChild(t); setTimeout(() => t.remove(), 2500); };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('app-view').style.display = 'flex';
                
                currentUid = user.uid;
                updateNotifButton();
                
                onValue(ref(db, 'users/' + currentUid), (snap) => {
                    const data = snap.val();
                    currentUsername = (data && data.username) ? data.username : (user.displayName || user.email.split('@')[0]);
                    document.getElementById('header-user-info').innerHTML = `<div class="profile-icon">${currentUsername.charAt(0).toUpperCase()}</div><span style="font-size:0.75rem; margin-left:8px;"><b>${currentUsername}</b></span>`;
                }, { onlyOnce: true });
                
                set(ref(db, `status/${currentUid}`), { state: 'online', last_changed: serverTimestamp() });
                onDisconnect(ref(db, `status/${currentUid}`)).set({ state: 'offline', last_changed: serverTimestamp() });
                loadRequests(); 
                loadFriends();
            } else {
                document.getElementById('login-view').style.display = 'flex';
                document.getElementById('app-view').style.display = 'none';
            }
        });

        document.addEventListener("visibilitychange", () => {
            if (!document.hidden && currentChatFriendUid) {
                set(ref(db, `chat_meta/${currentUid}/${currentChatFriendUid}/lastSeen`), serverTimestamp());
                unreadStates[currentChatFriendUid] = false;
                const badge = document.getElementById(`unread-${currentChatFriendUid}`);
                if(badge) badge.style.display = 'none';
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const email = document.getElementById('login-email').value; 
            const pass = document.getElementById('login-password').value; 
            const btn = e.target.querySelector('.submit-btn'); 
            btn.disabled=true; btn.innerHTML='...'; 
            try { 
                await setPersistence(auth, document.getElementById('remember-me').checked ? browserLocalPersistence : browserSessionPersistence); 
                await signInWithEmailAndPassword(auth, email, pass); 
            } catch(err) { 
                showAuthMessage("Hiba: " + err.message, 'error'); 
                btn.disabled=false; btn.textContent='Belépés'; 
            } 
        });
        
        document.getElementById('register-form').addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const u = document.getElementById('reg-username').value; 
            const em = document.getElementById('register-email').value; 
            const p = document.getElementById('register-password').value; 
            if(p!==document.getElementById('register-password2').value){
                showAuthMessage("Nem egyezik a jelszó",'error');
                return;
            } 
            try { 
                const uc = await createUserWithEmailAndPassword(auth, em, p); 
                await updateProfile(uc.user, {displayName:u}); 
                await set(ref(db,'users/'+uc.user.uid),{username:u,email:em}); 
            } catch(err) { 
                showAuthMessage("Hiba: "+err.message,'error'); 
            } 
        });
        
        document.getElementById('forgot-password').addEventListener('click', async(e)=>{
            e.preventDefault(); 
            try{
                await sendPasswordResetEmail(auth,document.getElementById('login-email').value);
                showAuthMessage("Email elküldve",'success');
            }catch(e){
                showAuthMessage("Add meg az emailt!",'error');
            }
        });
        
        window.logoutUser = function() { 
            if(currentUid) set(ref(db, `status/${currentUid}`), { state: 'offline', last_changed: serverTimestamp() }); 
            signOut(auth); 
        };
        
        window.openChatUI = function() { if (window.innerWidth <= 768) document.getElementById('body-tag').classList.add('chat-open'); };
        window.closeChat = function() { document.getElementById('body-tag').classList.remove('chat-open'); };

        window.sendRequest = function(uid, name) { 
            set(ref(db, `friend_requests/${uid}/${currentUid}`), { fromName: currentUsername, timestamp: serverTimestamp() })
            .then(() => { 
                showToast("KÉRÉS ELKÜLDVE!"); 
                searchResults.innerHTML = ''; 
                searchInput.value = ''; 
            }); 
        };
        
        function loadRequests() { 
            onValue(ref(db, `friend_requests/${currentUid}`), (snap) => { 
                const reqs = snap.val(); 
                const cont = document.getElementById('requests-list'); 
                const badge = document.getElementById('req-count'); 
                cont.innerHTML = ''; 
                if (!reqs) { badge.style.display='none'; return; } 
                badge.style.display='inline'; 
                for (let id in reqs) { 
                    cont.innerHTML += `<div class="user-card"><span>${reqs[id].fromName}</span><button class="btn-action" onclick="acceptFriend('${id}', '${reqs[id].fromName}')">ELFOGAD</button></div>`; 
                } 
            }); 
        }
        
        window.acceptFriend = function(uid, name) { 
            set(ref(db, `friends/${currentUid}/${uid}`), { username: name }); 
            set(ref(db, `friends/${uid}/${currentUid}`), { username: currentUsername }); 
            remove(ref(db, `friend_requests/${currentUid}/${uid}`)); 
        };

        // --- BARÁT LISTA ---
        function loadFriends() {
            onValue(ref(db, `friends/${currentUid}`), (snap) => {
                const friends = snap.val(); 
                const cont = document.getElementById('friends-list');
                cont.innerHTML = ''; 
                if (!friends) return;
                
                for (let uid in friends) {
                    const friendData = friends[uid];
                    const displayName = friendData.nickname || friendData.username;
                    
                    const card = document.createElement('div'); 
                    card.id = `f-${uid}`; 
                    card.className = 'user-card';
                    card.setAttribute('data-name', displayName + ' ' + friendData.username);
                    cont.appendChild(card);

                    if (unreadStates[uid] === undefined) unreadStates[uid] = false;

                    onValue(ref(db, `status/${uid}`), (sSnap) => {
                        const online = sSnap.val()?.state === 'online';
                        const dot = online ? '#4bff4b' : '#444';
                        updateFriendCardContent(uid, displayName, dot);
                    });

                    // Olvasatlan üzenetek figyelése
                    const chatId = [currentUid, uid].sort().join('_');
                    onValue(query(ref(db, `chats/${chatId}`), limitToLast(1)), (msgSnap) => {
                        const msgs = msgSnap.val();
                        if (msgs) {
                            const lastMsgKey = Object.keys(msgs)[0];
                            const lastMsg = msgs[lastMsgKey];
                            
                            onValue(ref(db, `chat_meta/${currentUid}/${uid}/lastSeen`), (seenSnap) => {
                                const lastSeen = seenSnap.val() || 0;
                                const isIncoming = lastMsg.senderId !== currentUid;
                                let isUnread = (lastMsg.timestamp > lastSeen) && isIncoming;
                                
                                const isChatOpen = (currentChatFriendUid === uid);
                                const isWindowVisible = !document.hidden;

                                if (isChatOpen && isWindowVisible) {
                                    isUnread = false;
                                    if(lastMsg.timestamp > lastSeen) {
                                        set(ref(db, `chat_meta/${currentUid}/${uid}/lastSeen`), serverTimestamp());
                                    }
                                }

                                unreadStates[uid] = isUnread;

                                const indicator = document.getElementById(`unread-${uid}`);
                                if(indicator) {
                                    indicator.style.display = isUnread ? 'inline-block' : 'none';
                                }

                                // Értesítés küldése
                                if (isUnread && lastMsg.timestamp > appStartTime && !isChatOpen) {
                                    sendNotification(displayName, lastMsg.text);
                                }

                            }, { onlyOnce: true });
                        }
                    });
                }
            });
        }

        function updateFriendCardContent(uid, name, statusColor) {
            const el = document.getElementById(`f-${uid}`);
            if(el) {
                const isUnread = unreadStates[uid] === true;
                el.innerHTML = `
                    <div class="user-info-click" onclick="openChat('${uid}', '${name}'); openChatUI();">
                        <div style="display:flex; align-items:center;">
                            <span id="unread-${uid}" class="unread-badge" style="display:${isUnread ? 'inline-block' : 'none'};"></span>
                            <b>${name}</b>
                        </div>
                        <span style="width:7px; height:7px; border-radius:50%; background:${statusColor}; margin-right:10px;"></span>
                    </div>
                `;
            }
        }

        // --- CHAT ---
        window.openChat = function(uid, name) {
            document.getElementById('active-chat-user').innerText = name.toUpperCase();
            
            currentChatFriendUid = uid;
            currentChatOriginalName = name; 

            if (!document.hidden) {
                unreadStates[uid] = false;
                const badge = document.getElementById(`unread-${uid}`);
                if(badge) badge.style.display = 'none';
                set(ref(db, `chat_meta/${currentUid}/${uid}/lastSeen`), serverTimestamp());
            }

            document.getElementById('chat-actions').style.display = 'flex';
            document.getElementById('delete-friend-btn').onclick = () => removeCurrentFriend(name);
            document.getElementById('rename-friend-btn').onclick = () => changeNickname();

            const ids = [currentUid, uid].sort(); 
            activeChatId = ids[0] + "_" + ids[1];
            
            onValue(query(ref(db, `chats/${activeChatId}`), limitToLast(50)), (snap) => {
                const cont = document.getElementById('chat-messages'); 
                const msgs = snap.val();
                let html = '';
                const toAttach = [];

                if (msgs) {
                    const keys = Object.keys(msgs);
                    const lastMsg = msgs[keys[keys.length - 1]];
                    if(lastMsg && lastMsg.senderId !== currentUid && !document.hidden) {
                        set(ref(db, `chat_meta/${currentUid}/${uid}/lastSeen`), serverTimestamp());
                    }

                    for (let id of keys) {
                        const m = msgs[id];
                        const side = m.senderId === currentUid ? 'sent' : 'received';
                        const date = new Date(m.timestamp);
                        const timeStr = date.toLocaleString('hu-HU', { hour: '2-digit', minute: '2-digit', month: 'short', day: 'numeric' });
                        const isMine = side === 'sent';

                        html += `
                            <div class="message-wrapper ${side}">
                                <div id="msg-${id}" class="message-bubble ${side} noselect" title="${timeStr}">
                                    ${escapeHtml(m.text)}
                                </div>
                                <div class="msg-options-pc">
                                    <i class="fa-solid fa-copy btn-msg-icon" onclick="copyText(\`${m.text.replace(/`/g, '\\`')}\`)" title="Másolás"></i>
                                    ${isMine ? `<i class="fa-solid fa-trash btn-msg-icon delete" onclick="deleteMessage('${id}')" title="Törlés"></i>` : ''}
                                </div>
                            </div>
                        `;
                        toAttach.push({ id, text: m.text, isMine });
                    }
                }
                
                cont.innerHTML = html;
                toAttach.forEach(item => {
                    const el = document.getElementById(`msg-${item.id}`);
                    if (el) addLongPressEvent(el, () => showMessageOptions(item.id, item.text, item.isMine));
                });
                cont.scrollTop = cont.scrollHeight;
            });
        };

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.copyText = function(text) {
            navigator.clipboard.writeText(text).then(() => showToast("Másolva!"));
        };

        window.changeNickname = function() {
            if (!currentChatFriendUid) return;
            showInput("Becenév beállítása", "Új név...", (newNick) => {
                update(ref(db, `friends/${currentUid}/${currentChatFriendUid}`), { nickname: newNick })
                .then(() => {
                    showToast("Becenév mentve!");
                    document.getElementById('active-chat-user').innerText = newNick.toUpperCase();
                });
            });
        };

        window.deleteMessage = function(msgId) {
            if (!activeChatId) return;
            showConfirm("Törlöd az üzenetet?", () => {
                remove(ref(db, `chats/${activeChatId}/${msgId}`)).then(() => showToast("Törölve"));
            });
        };

        window.removeCurrentFriend = function(name) {
            if (!currentChatFriendUid) return;
            showConfirm(`Törlöd ${name}-t a barátok közül?`, () => {
                remove(ref(db, `friends/${currentUid}/${currentChatFriendUid}`));
                remove(ref(db, `friends/${currentChatFriendUid}/${currentUid}`));
                showToast("Törölve");
                document.getElementById('chat-messages').innerHTML = '';
                document.getElementById('active-chat-user').innerText = 'VÁLASSZ VALAKIT';
                document.getElementById('chat-actions').style.display = 'none';
                activeChatId = null;
                currentChatFriendUid = null;
                if (window.innerWidth <= 768) closeChat();
            });
        };

        const sendMsg = () => {
            const i = document.getElementById('msg-input');
            if (!i.value.trim() || !activeChatId) return;
            push(ref(db, `chats/${activeChatId}`), { senderId: currentUid, text: i.value.trim(), timestamp: serverTimestamp() });
            i.value = '';
        };
        document.getElementById('send-btn').onclick = sendMsg;
        document.getElementById('msg-input').onkeypress = (e) => { if(e.key==='Enter') sendMsg(); };
    </script>
</body>
</html>
