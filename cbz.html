<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Képregény olvasó — kötetválasztó + elrejthető menü</title>
  <style>
    :root { --bg:#0e0f11; --fg:#e8e8e8; --muted:#9aa0a6; --accent:#7c3aed; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--fg); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }

    /* Felső sáv */
    header { position:sticky; top:0; z-index:10; transition: transform .2s ease; backdrop-filter:blur(6px);
             background: color-mix(in srgb, var(--bg) 85%, transparent); border-bottom:1px solid rgba(255,255,255,.08); }
    header.is-hidden { transform: translateY(-110%); }
    .container { max-width:1100px; margin:0 auto; padding:10px 16px; }
    .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .chip { background:#1a1c1f; border:1px solid rgba(255,255,255,.16); padding:6px 10px; border-radius:8px; }
    select { background:#1a1c1f; color:var(--fg); border:1px solid rgba(255,255,255,.18); padding:7px 10px; border-radius:8px; }
    #status { margin-left:auto; color:var(--muted); font-size:14px; }

    /* Menü toggle gomb (mindig látszik) */
    #menuToggle {
      position: fixed; top:10px; right:10px; z-index: 9999;
      background:#1a1c1f; color:var(--fg); border:1px solid rgba(255,255,255,.22);
      padding:8px 10px; border-radius:10px; cursor:pointer;
    }
    #menuToggle:hover { border-color: var(--accent); }

    main { padding:16px; }
    #pages { margin:0 auto; max-width:min(100%, 1400px); }
    .page { display:block; margin:0 auto 16px; width:100%; height:auto; background:#0a0b0d; box-shadow:0 1px 0 rgba(255,255,255,.02) inset; border-radius:0 !important; }
    footer { text-align:center; color:var(--muted); padding:24px 12px; font-size:14px; }
    kbd { background:#1a1c1f; border:1px solid rgba(255,255,255,.15); border-bottom-color:rgba(255,255,255,.25); padding:2px 6px; border-radius:6px; font-family:ui-monospace,SFMono-Regular,Menlo,monospace; }
    .err { opacity:.85; font-size:.9em; }
  </style>
</head>
<body>
  <!-- Menü toggle gomb -->
  <button id="menuToggle" aria-expanded="true">✕ Menü</button>

  <header id="topbar">
    <div class="container controls">
      <!-- kötetválasztó csak -->
      <div style="display:flex; gap:8px; align-items:center;">
        
        <select id="volSelect" title="Kötet kiválasztása"></select>
      </div>

      <!-- oldalak száma -->
      <span id="status">0 / 0</span>
    </div>
  </header>

  <main>
    <div id="pages"></div>
  </main>

  
  <script>
    // ===== KONFIG =====
    const VOLUME_ROOT = './zip';
    const VOLUMES = [
      'Chainsaw Man v01','Chainsaw Man v02','Chainsaw Man v03','Chainsaw Man v04','Chainsaw Man v05',
      'Chainsaw Man v06','Chainsaw Man v07','Chainsaw Man v08','Chainsaw Man v09','Chainsaw Man v10',
      'Chainsaw Man v11','Chainsaw Man v12','Chainsaw Man v13','Chainsaw Man v14','Chainsaw Man v15',
      'Chainsaw Man v16','Chainsaw Man v17','Chainsaw Man v18','Chainsaw Man v19'
    ];
    const IMAGE_EXT = /\.(jpe?g|png|webp)$/i; // mit tekintünk képnek
    // ===================

    (function(){
      const pagesEl   = document.getElementById('pages');
      const statusEl  = document.getElementById('status');
      const volSelect = document.getElementById('volSelect');
      const topbar    = document.getElementById('topbar');
      const menuBtn   = document.getElementById('menuToggle');

      let currentBaseUrl = null;
      let knownList = [];     // pontos fájllista a mappából
      let loadedCount = 0;
      let ioImgs = null;

      // ---- util ----
      function encodedJoin(base, path){
        const b = encodeURI(base).replace(/\/$/, '');
        const parts = path.split('/').map((p,i,a)=> i===a.length-1 ? encodeURIComponent(p) : encodeURI(p));
        return `${b}/${parts.join('/')}`;
      }
      async function tryFetch(url){
        try{ const r = await fetch(url, { cache:'no-cache' }); return r.ok ? r : null; }
        catch{ return null; }
      }
      function clearAll(){
        pagesEl.innerHTML = '';
        loadedCount = 0; updateStatus();
        if (ioImgs) { ioImgs.disconnect(); ioImgs = null; }
      }
      function updateStatus(){
        statusEl.textContent = `${loadedCount} / ${knownList.length}`;
      }
      function naturalSort(arr){
        const coll = new Intl.Collator(undefined, { numeric:true, sensitivity:'base' });
        return arr.sort((a,b)=> coll.compare(a,b));
      }

      // ---- manifest / könyvtárlistázás ----
      async function loadFromManifest(baseUrl){
        const u1 = encodedJoin(baseUrl, 'manifest.txt');
        const u2 = encodedJoin(baseUrl, 'manifest.json');
        for (const u of [u1,u2]){
          const res = await tryFetch(u); if (!res) continue;
          const ct = res.headers.get('content-type')||'';
          try{
            if (u.endsWith('.json') || ct.includes('application/json')){
              const arr = await res.json(); return Array.isArray(arr) ? arr.filter(n=>IMAGE_EXT.test(n)) : [];
            } else {
              const txt = await res.text();
              return txt.split(/\r?\n/).map(s=>s.trim()).filter(s=>s && IMAGE_EXT.test(s));
            }
          }catch{}
        }
        return null;
      }
      async function listDirectoryOnce(baseUrl){
        // egyszerű statikus szerver (pl. npx serve) HTML indexéből olvas
        const res = await tryFetch(encodeURI(baseUrl) + '/');
        if (!res) return null;
        const ct = res.headers.get('content-type')||'';
        if (!ct.includes('text/html')) return null;
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const names = Array.from(doc.querySelectorAll('a'))
          .map(a => a.getAttribute('href')||'')
          .filter(h => h && !h.endsWith('/'))
          .map(h => decodeURIComponent(h.replace(/^.*\//,'')))
          .filter(name => IMAGE_EXT.test(name));
        return names.length ? names : null;
      }
      async function getExactFileList(baseUrl){
        const m = await loadFromManifest(baseUrl);
        if (m && m.length) return naturalSort(m);
        const l = await listDirectoryOnce(baseUrl);
        if (l && l.length) return naturalSort(l);
        return null;
      }

      // ---- render ismert listából ----
      function observeImages(){
        ioImgs = new IntersectionObserver((entries)=>{
          for (const entry of entries){
            const img = entry.target;
            if (!entry.isIntersecting || img.dataset.loading === '1') continue;
            img.dataset.loading = '1';
            img.src = encodedJoin(currentBaseUrl, img.dataset.name);
            img.addEventListener('load', ()=>{ loadedCount++; updateStatus(); }, { once:true });
            img.addEventListener('error', ()=>{ img.classList.add('err'); img.alt = `Nem sikerült: ${img.dataset.name}`; }, { once:true });
          }
        }, { rootMargin:'900px 0px', threshold:0.01 });
        document.querySelectorAll('img.page').forEach(img => ioImgs.observe(img));
        updateStatus();
      }
      function renderKnownList(list){
        clearAll();
        knownList = list.slice(); // természetes sorrend
        const frag = document.createDocumentFragment();
        knownList.forEach((name, idx)=>{
          const img = document.createElement('img');
          img.className = 'page';
          img.alt = name;
          img.dataset.name = name;
          img.dataset.idx = String(idx);
          img.loading = 'lazy';
          frag.appendChild(img);
        });
        pagesEl.appendChild(frag);
        observeImages();
      }

      // ---- kötet betöltés ----
      async function loadVolume(volumeName){
        currentBaseUrl = `${VOLUME_ROOT.replace(/\/$/, '')}/${volumeName}`;
        document.title = `Képregény — ${volumeName}`;
        const list = await getExactFileList(currentBaseUrl);
        if (!list){
          renderKnownList([]); // ürit
          statusEl.textContent = '0 / 0';
          alert('A böngésző nem tudja kilistázni a mappát.\nAdj manifest.txt / manifest.json-t a kötet mappájába, vagy futtasd egyszerű szerverrel (pl. "npx serve .").');
          return;
        }
        renderKnownList(list);
        // ugorjunk az elejére
        window.scrollTo({ top: 0, behavior: 'instant' });
      }

      // ---- UI: kötetlista + menügomb ----
      function populateVolumes(){
        volSelect.innerHTML = '';
        VOLUMES.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; volSelect.appendChild(o); });
        volSelect.value = VOLUMES[0];
      }
      volSelect.addEventListener('change', ()=> loadVolume(volSelect.value));

      // Menü elrejtése / visszahozása
      function setMenuHidden(hidden){
        if (hidden){
          topbar.classList.add('is-hidden');
          menuBtn.textContent = '☰ Menü';
          menuBtn.setAttribute('aria-expanded','false');
        } else {
          topbar.classList.remove('is-hidden');
          menuBtn.textContent = '✕ Menü';
          menuBtn.setAttribute('aria-expanded','true');
        }
      }
      menuBtn.addEventListener('click', ()=>{
        const hidden = topbar.classList.contains('is-hidden');
        setMenuHidden(!hidden);
      });

      // Hotkeys
      window.addEventListener('keydown', (e) => {
        const t = e.target;
        if (t && (t.tagName==='INPUT'||t.tagName==='TEXTAREA'||t.isContentEditable)) return;
        if (e.key.toLowerCase()==='j') window.scrollBy({ top: window.innerHeight*0.9, behavior:'smooth' });
        if (e.key.toLowerCase()==='k') window.scrollBy({ top: -window.innerHeight*0.9, behavior:'smooth' });
        if (e.key==='Home') window.scrollTo({ top:0, behavior:'smooth' });
        if (e.key==='End') window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
        if (e.key.toLowerCase()==='m'){ const hidden = topbar.classList.contains('is-hidden'); setMenuHidden(!hidden); }
      });

      // start
      (async () => {
        populateVolumes();
        await loadVolume(volSelect.value);
        setMenuHidden(false); // induláskor látszik
      })();
    })();
  </script>
</body>
</html>
